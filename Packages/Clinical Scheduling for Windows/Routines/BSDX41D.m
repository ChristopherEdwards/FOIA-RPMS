BSDX41D ; IHS/OIT/HMW/MSC/SAT - WINDOWS SCHEDULING RPCS ;
 ;;3.0;IHS WINDOWS SCHEDULING;;DEC 09, 2010
 ;
MEASP ; ******************** MEASUREMENT PANELS * 9000010.01 *******
 ; <SETUP>
 Q:'$D(^AUPNVMSR("AA",APCHSPAT))
 X APCHSBRK
 ; <BUILD>  APCHSCTL-HLTH SUM TYPE
 F APCHSPOR=0:0 S APCHSPOR=$O(^APCHSCTL(APCHSTYP,3,APCHSPOR)) Q:'APCHSPOR  S APCHSND2=APCHSNDM,APCHSDMX=0 D PBLD
 ;now display lab refusals
 S APCHST="MEASUREMENT",APCHSFN=9999999.07 D DISPREF^APCHS3C
 K APCHST,APCHSFN
MEASPX K APCHSPOR,APCHSPDF,APCHSCOR,APCHSCT,APCHSCT2,APCHSCT3,APCHSCLN,APCHSMT,APCHSML,APCHSTSQ,APCHSTVL,APCHSVAL,APCHSIVD,APCHST,APCHSC,APCHSND2,APCHSDMX,APCHSDFN,APCHSDAT,APCHSDM2,APCHSPS1,APCHSIDT,APCHSNTS,Y,X
 Q
PBLD S APCHSPDF=$P(^APCHSCTL(APCHSTYP,3,APCHSPOR,0),U,2)
 K APCHSTSQ,APCHSTVL,APCHSNTS
 S APCHSNTS=0
 F APCHSPS1=1,0 F APCHSCOR=0:0 S APCHSCOR=$O(^APCHSMPN(APCHSPDF,1,APCHSCOR)) Q:APCHSCOR=""  D CBLD
 D POUT
 Q
CBLD S APCHSP=^APCHSMPN(APCHSPDF,1,APCHSCOR,0) S APCHSCT3=$G(^(1))
 S APCHSCT=$P(APCHSP,U,2),APCHSCLN=$P(APCHSP,U,3)
 S X=$P(APCHSP,U,5) S:X]"" APCHSNTS(X)=""
 S:APCHSCT="" APCHSCT=" " S APCHSCT2=$S($D(^AUTTMSR(APCHSCT,0)):$P(^(0),U,1),1:APCHSCT)
 S:$P(APCHSP,U,4)]"" APCHSCT2=$P(APCHSP,U,4)
 S:APCHSCLN="" APCHSCLN=10
 S APCHSTSQ(APCHSCOR,1)=APCHSCT2,APCHSTSQ(APCHSCOR,2)=APCHSCLN,APCHSTSQ(APCHSCOR,3)=APCHSCT3
 I APCHSPS1 S APCHSIVD="" F APCHSQ=0:0 S APCHSIVD=$O(^AUPNVMSR("AA",APCHSPAT,APCHSCT,APCHSIVD)) Q:APCHSIVD=""!(APCHSIVD>APCHSDLM)  D CBLD2
 I 'APCHSPS1 S APCHSIVD=$O(^AUPNVMSR("AA",APCHSPAT,APCHSCT,0)) I APCHSIVD,'$D(APCHSTVL(APCHSIVD,APCHSCOR)) D CBLD3
 Q
CBLD2 I '$D(APCHSTVL(APCHSIVD)) S APCHSND2=APCHSND2-1 I APCHSND2=-1 S APCHSND2=0 Q:APCHSDMX&(APCHSIVD'<APCHSDMX)  K APCHSTVL(APCHSDMX) F APCHSDM2=0:0 S APCHSDM2=$O(APCHSTVL(APCHSDM2)) Q:'APCHSDM2  S APCHSDMX=APCHSDM2
 S:APCHSIVD>APCHSDMX APCHSDMX=APCHSIVD
CBLD3 S APCHSDFN=$O(^AUPNVMSR("AA",APCHSPAT,APCHSCT,APCHSIVD,"")),APCHSVAL=$P(^AUPNVMSR(APCHSDFN,0),U,4),APCHSTVL(APCHSIVD,APCHSCOR)=APCHSVAL_"^"_$P(^AUPNVMSR(APCHSDFN,0),U,6)
 Q
 ; <DISPLAY>
POUT X APCHSCKP Q:$D(APCHSQIT)  S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=$C(30)
 X APCHSCKP Q:$D(APCHSQIT)  D PHDR
 S APCHSIVD="" F APCHSQ=0:0 S APCHSIVD=$O(APCHSTVL(APCHSIVD)) Q:APCHSIVD=""  X APCHSCKP Q:$D(APCHSQIT)  D:APCHSNPG PHDR D PLINE
 I $O(APCHSNTS(0))]"" S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=$C(30) S X="" F  S X=$O(APCHSNTS(X)) Q:X=""  S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=X_$C(30)
 Q
PHDR S APCHST=10,APCHSC=""
 F APCHSQ=0:0 S APCHSC=$O(APCHSTSQ(APCHSC)) Q:APCHSC=""  S APCHSMT=APCHSTSQ(APCHSC,1),APCHSML=APCHSTSQ(APCHSC,2) S BSDXTMP=$$FILL^BSDX41(APCHST+1+(APCHSML-$L(APCHSMT)\2))_APCHSMT S APCHST=APCHST+APCHSML+2
 S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=BSDXTMP_$C(30)
 Q
PLINE S APCHSIDT=APCHSIVD,Y=-APCHSIVD\1+9999999 X APCHSCVD S APCHSDAT=Y
 S BSDXTMP=APCHSDAT S APCHST=11
 S APCHSC="" F APCHSQ=0:0 S APCHSC=$O(APCHSTSQ(APCHSC)) Q:APCHSC=""  D PVAL
 S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=BSDXTMP_$C(30)
 Q
PVAL ;
 K APCHSVNM
 S APCHSML=APCHSTSQ(APCHSC,2)
 S (APCHSVAL,APCHSVNM)="",APCHSVAL=$P($G(APCHSTVL(APCHSIVD,APCHSC)),U) I $P($G(APCHSTVL(APCHSIVD,APCHSC)),U,2)]"" S APCHSVNM=$P($G(APCHSTVL(APCHSIVD,APCHSC)),U,2)
 I APCHSVAL]"" S X=APCHSVAL X APCHSTSQ(APCHSC,3) S APCHSVAL=$P(X,"^",1),X=$P(X,"^",2) S:X]"" APCHSNTS(X)=""
 S:APCHSVAL]"" APCHSVAL=$S($P(APCHSML,".",2)="":$J(APCHSVAL,$P(APCHSML,".",1)),1:$J(APCHSVAL,$P(APCHSML,".",1),$P(APCHSML,".",2)))
 S BSDXTMP=BSDXTMP_$$FILL^BSDX41(APCHST)_APCHSVAL S APCHST=APCHST+APCHSML+2
 K APCHSVNM
 Q
 ;
EYERX ; *************** EYE GLASS PRESCRIPTIONS * 9000010.04 *******
 ; <SETUP>
 Q:'$D(^AUPNVEYE("AA",APCHSPAT))
 X APCHSCKP Q:$D(APCHSQIT)  X:'APCHSNPG APCHSBRK
 S APCHSDT=$O(^AUPNVEYE("AA",APCHSPAT,0))
 S APCHSN=$O(^AUPNVEYE("AA",APCHSPAT,APCHSDT,0))
 S APCHSP=^AUPNVEYE(APCHSN,0),APCHSVDF=$P(APCHSP,U,3) D GETSITEV^APCHSUTL
 S Y=-APCHSDT\1+9999999 X APCHSCVD S APCHSDAT=Y
BLD ; <BUILD>
 S APCHSEN=$G(^AUPNVEYE(APCHSN,19))
 S APCHST="Reading only^^^^^^^^^^^^Pupil near^Pupil  far"
 S APCHSJ="1^^^^^^^^^2^2^4^2^2"
 S APCHSL="" F APCHSI=1,13 D ADDTOL
 S APCHSL1=$E(APCHSL,3,255)
 S APCHSL="" F APCHSI=14 D ADDTOL
 S APCHSL2=$E(APCHSL,3,255)
 S APCHST=""
 S APCHSL="R" F APCHSI=2,3,4,15,8 D BLDL
DSPLY ;<DISPLAY>
 X APCHSCKP Q:$D(APCHSQIT)  S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=APCHSDAT_$$FILL^BSDX41(10-$L(APCHSDAT))_APCHSNSH_$C(30)
 X APCHSCKP Q:$D(APCHSQIT)  S:APCHSNPG BSDXTMP=BSDXTMP_APCHSDAT_$$FILL^BSDX41(10-$L(APCHSDAT))_APCHSNSH_$C(10,13)
 S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)="  Sphere    Cyl   Axis  Prism  Add"_$C(30)
 X APCHSCKP Q:$D(APCHSQIT)  D:APCHSNPG NPG S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=APCHSL_$$FILL^BSDX41(44-$L(APCHSL))_APCHSL1_$C(30)
 S APCHSL="L" F APCHSI=5,6,7,16,9 D BLDL
 X APCHSCKP Q:$D(APCHSQIT)  D:APCHSNPG NPG S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=APCHSL_$$FILL^BSDX41(61-$L(APCHSL))_APCHSL2_$C(30)
EYEMEAS ;display eye care measurements
 K APCHSMT
 S APCHSM=$O(^AUTTMSR("C","07",0)),APCHSP=1 I APCHSM D GATHER
 S APCHSM=$O(^AUTTMSR("C","08",0)),APCHSP=2 I APCHSM D GATHER
 S APCHSM=$O(^AUTTMSR("C","11",0)),APCHSP=3 I APCHSM D GATHER
 D DISPEM
 ; <CLEANUP>
EYERXX K APCHSDAT,APCHSDT,APCHSEN,APCHSF,APCHSI,APCHSJ,APCHSL,APCHSL1,APCHSL2,APCHSN,APCHST,APCHSVDF,Y,APCHSM,APCHSVNM,APCHSMT,APCHSM,APCHSJ,APCHSX
 Q
GATHER ;gather up last 5 of measurement in array by inverse date
 S (C,D,N)=0 F  S D=$O(^AUPNVMSR("AA",APCHSPAT,APCHSM,D)) Q:D'=+D  S N=0 F  S N=$O(^AUPNVMSR("AA",APCHSPAT,APCHSM,D,N)) Q:N'=+N!(C>3)  S C=C+1,$P(APCHSMT(D),U,APCHSP)=$$VAL^XBDIQ1(9000010.01,N,.04)
 Q
DISPEM ;display eye measurements
 X APCHSCKP Q:$D(APCHSQIT)
 S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=$C(30)
 S BSDXTMP=$$FILL^BSDX41(29)_"Eye Care Measurements"
 X APCHSCKP Q:$D(APCHSQIT)
 S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=BSDXTMP_$C(30)
 S BSDXDSP=$$FILL^BSDX41(15)_"VU"
 S BSDXDSP=BSDXDSP_$$FILL^BSDX41(34-$L(BSDXDSP))_"VC"
 S BSDXDSP=BSDXDSP_$$FILL^BSDX41(48-$L(BSDXDSP))_"TONOMETRY"
 S BSDXTMP=BSDXTMP__BSDXDSP
 S APCHSX=0 F  S APCHSX=$O(APCHSMT(APCHSX)) Q:APCHSX=""!($D(APCHSQIT))  X APCHSCKP Q:$D(APCHSQIT)  D
 . S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=BSDXTMP_$C(30)
 . S BSDXDSP=$$FMTE^XLFDT((9999999-APCHSX),"2D")
 . S APCHSJ="10;29;48"
 . F APCHST=1:1:3 S BSDXDSP=BSDXDSP_$$FILL^BSDX41($P(APCHSJ,";",APCHST)-$L(BSDXDSP))_$P(APCHSMT(APCHSX),U,APCHST)
 . S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=BSDXDSP_$C(30)
 Q
ADDTOL S APCHSF=$P(APCHSEN,U,APCHSI) S:APCHSF="" APCHSF="-" S APCHSF=$J(APCHSF,$P(APCHSJ,U,APCHSI))
 S:APCHSF]"" APCHSL=APCHSL_"  "_$P(APCHST,U,APCHSI)_": "_APCHSF
 Q
BLDL S APCHSF=$J($P(APCHSEN,U,APCHSI),7)
 S APCHSL=APCHSL_APCHSF
 Q
NPG S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=APCHSDAT_$$FILL^BSDX41(10-$L(APCHSDAT))_APCHSNSH_$C(30)
 S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)="  Sphere    Cyl   Axis  Prism  Add"_$C(30)
 Q
 ;
 ;
EKG ; ***** EKG SUMMARY * 9000010.21 (V DIAGNOSTIC PROCEDURE RESULT) *****
 ;<setup>
 ;Q:'$D(^AUPNVDXP("AC",APCHSPAT))
 I '$D(^AUPNVDXP("AC",APCHSPAT)),'$D(^AUPNPREF("AA",APCHSPAT,9999999.68,691.500002)) Q
 X APCHSCKP Q:$D(APCHSQIT)  X:'APCHSNPG APCHSBRK
 S APCHSCNT=0
 S APCHSDAT=0 F APCHSQ=0:0 S APCHSDAT=$O(^AUPNVDXP("AA",APCHSPAT,APCHSDAT)) Q:'APCHSDAT  D  Q:$D(APCHSQIT)
 . S APCHSIVD=0 F APCHQ=0:0 S APCHSIVD=$O(^AUPNVDXP("AA",APCHSPAT,APCHSDAT,APCHSIVD)) Q:APCHSIVD=""!(APCHSIVD>APCHSDLM)  D  Q:$D(APCHSQIT)
 .. S APCHSDFN=0 F APCHQ=0:0 S APCHSDFN=$O(^AUPNVDXP("AA",APCHSPAT,APCHSDAT,APCHSIVD,APCHSDFN)) Q:'APCHSDFN  D EKGDSP Q:$D(APCHSQIT)
 .. Q
 . Q
 ;NOW DISPLAY EKG REFUSALS
 Q:'$D(^AUPNPREF("AA",APCHSPAT,9999999.68,691.500002))
 X APCHSCKP Q:$D(APCHSQIT)
 S APCHSD=0 F  S APCHSD=$O(^AUPNPREF("AA",APCHSPAT,9999999.68,691.500002,APCHSD)) Q:APCHSD=""!(APCHSD>APCHSDLM)!($D(APCHSQIT))  D
 .S APCHSI=0 F  S APCHSI=$O(^AUPNPREF("AA",APCHSPAT,9999999.68,691.500002,APCHSD,APCHSI)) Q:APCHSI=""!($D(APCHSQIT))  D
 ..X APCHSCKP Q:$D(APCHSQIT)
 ..S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=$C(30)
 ..S BSDXDSP=$$DATE^APCHSMU(9999999-APCHSD)
 ..S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=BSDXDSP_$$FILL^BSDX41(12-$L(BSDXDSP))_"("_$$VAL^XBDIQ1(9000022,APCHSI,.07)_")"_"   "_$$VAL^XBDIQ1(9000022,APCHSI,.04)_$C(30)
 ..Q
 .Q
 Q
 ;
EKGX ; exit EKG
 ;<CLEANUP>
 K APCHSDP,APCHSDFN,APCHSNRQ,APCHSDAT,APCHSDS,APCHSN,APCHSIVD,APCHSVL,APCHSCNT,Y
 Q
 ;
EKGDSP ;display EKG(S)
 ; <DISPLAY>
 S APCHSN=^AUPNVDXP(APCHSDFN,0)
 S APCHSDP=$P(APCHSN,U,1)
 D GETEKG Q:APCHSDP=""
 S APCHSCNT=APCHSCNT+1
 S APCHSDS="DATE?"
 S Y=$P(APCHSN,U,3),Y=+^AUPNVSIT(Y,0)\1 X APCHSCVD S APCHSDS=Y
 S APCHSVL=$P($P(APCHSN,U,4),":")
 S APCHSVL=$S(APCHSVL="N":"NORMAL",APCHSVL="A":"ABNORMAL",APCHSVL="B":"BORDERLINE",1:"<none recorded>")
 X APCHSCKP Q:$D(APCHSQIT)
 S BSDXDSP=APCHSDS
 S BSDXDSP=BSDXDSP_$$FILL^BSDX41(12-$L(BSDXDSP))_APCHSDP
 S BSDXI=BSDXI+1 S ^BSDXTMP($J,BSDXI)=BSDXDSP_$$FILL^BSDX41(30-$L(BSDXDSP))_"RESULT: "_APCHSVL_$C(30)
 Q
GETEKG ;get EKG
 S APCHSDP=$P(^AUTTDXPR(APCHSDP,0),U)
 Q
