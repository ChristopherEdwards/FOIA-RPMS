BARDMRE ;IHS/OIT/FCJ - DEBT MANAGEMENT-ERROR REPORT ; 11 Jul 2012  1:34 PM
 ;;1.8;IHS ACCOUNTS RECEIVABLE;**22**;OCT 26, 2005;Build 38
 ;New routine 5-12-2011 for Debt Letter Management
 ;
 ;This report will provide letters ready to be printed by cycle, Insurer and detail
 ;
 ;
ST ;
 S BMCQ=0,BARRPT="C",BARSEQ=0
 W !!,"Report for Errors in Letters to be printed"
 D PAR^BARDMU
 D RRDT^BARDMU
 D ZIS
 Q
 ;
ZIS ;
 D ZIS^BARDMU
 G:$G(BARQUIT) XIT
 S XBRC="CALC^BARDMRE(1)",XBRX="XIT^BARDMRE",XBNS="BAR"
 I $G(BAROPT)="B" S XBRP="VIEWR^XBLM(""PRINT^BARDMRE"")",XBIOP=0
 E  S XBRP="PRINT^BARDMRE"
 D ^XBDBQUE
 D XIT
 Q
XIT ;
 K ^TMP("BARDME",$J)
 I $D(IO("S")) S IOP="`"_IOS D ^%ZIS Q
 D ^%ZISC
 ;K DIR,L,L1,L2,C,CT,CYCLE,TST  ;bar*1.8*22 SDR
 K DIR,BARL,BARL1,BARL2,BARC,BARCT,BARCYCLE,BARTST  ;bar*1.8*22 SDR
 Q
 ;
CALC(BARCALL) ;
 ;S ERRCT=0  ;bar*1.8*22 SDR
 S BARERRCT=0  ;bar*1.8*22 SDR
 D ^BARDMBS     ;CHECK FOR OUTSTANDING BILLS
 S BARCT=0,BARCTQ=0
 ;F CYCLE="CYCLE 1","CYCLE 2","CYCLE 3","CYCLE 4" D A1 Q:BARCTQ  ;bar*1.8*22 SDR
 F BARCYCLE="CYCLE 1","CYCLE 2","CYCLE 3","CYCLE 4" D A1 Q:BARCTQ  ;bar*1.8*22 SDR
 Q
 ;
A1 ;
 S BARDM=0
 ;start old code bar*1.8*22 SDR
 ;F  S BARDM=$O(^BARDM(DUZ(2),"S","Q",CYCLE,BARDM)) Q:BARDM'?1N.N  D  Q:BARCTQ
 ;.S BARDMC=0
 ;.F  S BARDMC=$O(^BARDM(DUZ(2),"S","Q",CYCLE,BARDM,BARDMC)) Q:BARDMC'?1N.N  D  Q:BARCTQ
 ;..S BARBIEN=$P(^BARDM(DUZ(2),BARDM,0),U)
 ;..S BARBILN=$$VAL^XBDIQ1(90053.05,BARDM,.01)
 ;..I BARPPF=1 S BARBILN=BARBILN_"*"  ;bar*1.8*22 SDR
 ;..S BARDAC=$P(^BARBL(DUZ(2),BARBIEN,0),U,3),BARD3P=$P(^(0),U,17)
 ;..S BARD3PD=$P(^BARBL(DUZ(2),BARBIEN,0),U,22)  ;bar*1.8*22 SDR
 ;..D INSTYP^BARDMU
 ;..S BARDI=$$VAL^XBDIQ1(90050.02,BARDAC,.01)
 ;..I $P(^BARBL(DUZ(2),BARBIEN,0),U,15)'>0 D PAID Q
 ;..D POLCHK
 ;..S:'$P($G(^BARBL(DUZ(2),BARBIEN,1)),U,2) ^TMP("BARDME",$J,BARDM,5)=BARHRN_U_BARBILN_U_BARDI_U_"Date of Service",ERRCT=ERRCT+1
 ;..I BARRPT="L" S BARCT=BARCT+1 S:BARCT=BARPMX BARCTQ=1
 ;end old code start new code
 F  S BARDM=$O(^BARDM(DUZ(2),"S","Q",BARCYCLE,BARDM)) Q:BARDM'?1N.N  D  Q:BARCTQ
 .Q:$P(^BARDM(DUZ(2),BARDM,0),U,2)'="A"
 .S BARDMC=0
 .F  S BARDMC=$O(^BARDM(DUZ(2),"S","Q",BARCYCLE,BARDM,BARDMC)) Q:BARDMC'?1N.N  D  Q:BARCTQ
 ..;test for letter already printed
 ..S BARTC="",BARPPF=0
 ..F  S BARTC=$O(^BARDM(DUZ(2),"S","P",BARTC)) Q:$G(BARTC)=""  D
 ...I $D(^BARDM(DUZ(2),"S","P",BARTC,BARDM)) S BARPPF=1
 ..S BARBIEN=$P(^BARDM(DUZ(2),BARDM,0),U)
 ..S BARBILN=$$VAL^XBDIQ1(90053.05,BARDM,.01)
 ..I BARPPF=1 S BARBILN=BARBILN_"*"
 ..S BARDAC=$P(^BARBL(DUZ(2),BARBIEN,0),U,3),BARD3P=$P(^(0),U,17)
 ..S BARD3PD=$P(^BARBL(DUZ(2),BARBIEN,0),U,22)
 .. ;
 ..I '$D(^ABMDBILL(BARD3PD,BARD3P)) QUIT  ;DUPLICATE BILL / NONEX CLAIM # P.OTT ADDED FROM BARDMLP
 .. ; 
 ..I BARCALL=2 I BARCYCLE'="CYCLE 1" S CY=+$P(BARCYCLE," ",2) D CYDAY^BARDMRU I BARLQ=0 S PETERCN=$G(PETERCN)+1 QUIT   ;P.OTT
 ..D INSTYP^BARDMU
 ..S BARDI=$$VAL^XBDIQ1(90050.02,BARDAC,.01)
 ..I $P(^BARBL(DUZ(2),BARBIEN,0),U,15)'>0 D PAID Q
 ..D POLCHK
 ..S:'$P($G(^BARBL(DUZ(2),BARBIEN,1)),U,2) ^TMP("BARDME",$J,BARDM,5)=BARHRN_U_BARBILN_U_BARDI_U_"Date of Service",ERRCT=ERRCT+1
 ..I BARRPT="L" S BARCT=BARCT+1 S:BARCT=BARPMX BARCTQ=1
 ;end new code
 Q
PAID ;SET THE PRINT QUEUED STATUS TO NOT QUEUED AND BILL STATUS TO PAID
 S DIE="^BARDM("_DUZ(2)_","_BARDM_",100,",DA(1)=BARDM,DA=BARDMC
 S DR=".03///N"
 D ^DIE
 K DIE,DA,DR
 S DIE="^BARDM("_DUZ(2)_",",DA=BARDM,DR=".02///P"
 D ^DIE
 K DIE,DA,DR
 Q
 ;
POLCHK ;TEST FOR POLICY NO, POLICY HOLDER AND POLICY HOLDER DOB
 S BARMIN=0,BARDM("PAT_IEN")="",BARHRN="",BARPAT=""
 I BARDACG'="VA(" D
 .S BARDM("PAT_IEN")=$P(^BARBL(DUZ(2),BARBIEN,1),U)
 .;S BARHRN=$P(^AUPNPAT(BARDM("PAT_IEN"),41,DUZ(2),0),U,2)  ;bar*1.8*22 SDR for <UNDEF>POLCHK+4^BARDMRE
 .S BARHRN=$P($G(^AUPNPAT(BARDM("PAT_IEN"),41,DUZ(2),0)),U,2)  ;bar*1.8*22 SDR for <UNDEF>POLCHK+4^BARDMRE
 .S BARPAT=$P(^DPT(BARDM("PAT_IEN"),0),U)
 S (BARDM("INS"),BARDM("MEMBER"),BARDM("POL_HOLDER"),BARDM("POL_NUM"),BARDM("POL_DOB"),BARDM("INS_TX"))=""
 I BARDACG="AUTNINS(" D INSCHK
 Q
INSCHK ;CHECK INSURANCE 
 ;S:$P(^AUTNINS(BARDACI,0),U,11)="" ^TMP("BARDME",$J,BARDM,6)=BARHRN_U_BARBILN_U_BARDI_U_"Tax ID",ERRCT=ERRCT+1  ;bar*1.8*22 SDR
 S:$P(^AUTNINS(BARDACI,0),U,11)="" ^TMP("BARDME",$J,BARDM,6)=BARHRN_U_BARBILN_U_BARDI_U_"Tax ID",BARERRCT=BARERRCT+1  ;bar*1.8*22 SDR
 I (+$G(^ABMDBILL(BARD3PD,BARD3P,0))=0) S ^TMP("BARDME",$J,BARDM,9)=BARHRN_U_BARBILN_U_BARDI_U_"3P Bill",BARERRCT=BARERRCT+1 Q  ;bar*1.8*22 SDR
 ;I $P(^ABMDBILL(DUZ(2),BARD3P,0),U)'=$E(BARBILN,1,$L($P(^ABMDBILL(DUZ(2),BARD3P,0),U))) S ^TMP("BARDME",$J,BARDM,6)=BARHRN_U_BARBILN_U_BARDI_U_"3P Pointer",ERRCT=ERRCT+1 Q  ;bar*1.8*22 SDR
 I $P(^ABMDBILL(BARD3PD,BARD3P,0),U)'=$E(BARBILN,1,$L($P(^ABMDBILL(BARD3PD,BARD3P,0),U))) S ^TMP("BARDME",$J,BARDM,6)=BARHRN_U_BARBILN_U_BARDI_U_"3P Pointer",BARERRCT=BARERRCT+1 Q  ;bar*1.8*22 SDR
 ;S TST=0  ;bar*1.8*22 SDR
 S BARTST=0  ;bar*1.8*22 SDR
 ;I $D(^ABMDBILL(DUZ(2),BARD3P,13,"B",BARDACI)) D  ;bar*1.8*22 SDR
 I $D(^ABMDBILL(BARD3PD,BARD3P,13,"B",BARDACI)) D  ;bar*1.8*22 SDR
 .;S L="",L=$O(^ABMDBILL(DUZ(2),BARD3P,13,"B",BARDACI,L))  ;bar*1.8*22 SDR
 .S BARL="",BARL=$O(^ABMDBILL(BARD3PD,BARD3P,13,"B",BARDACI,BARL))  ;bar*1.8*22 SDR
 .D INSCHK1
 ;Q:TST=1  ;bar*1.8*22 SDR
 Q:BARTST=1  ;bar*1.8*22 SDR
 ;start old code bar*1.8*22 SDR
 ;S L=0 F  S L=$O(^ABMDBILL(DUZ(2),BARD3P,13,L)) Q:L'?1N.N  D  Q:TST=1
 ;.I $P(^ABMDBILL(DUZ(2),BARD3P,13,L,0),U,11)=BARDACI D INSCHK1
 ;I TST=0 S ^TMP("BARDME",$J,BARDM,8)=BARHRN_U_BARBILN_U_BARDI_U_"Account/Ins Mismatch",ERRCT=ERRCT+1
 ;end old code start new code
 S BARL=0 F  S BARL=$O(^ABMDBILL(BARD3PD,BARD3P,13,BARL)) Q:BARL'?1N.N  D  Q:BARTST=1
 .I $P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U,11)=BARDACI D INSCHK1
 I BARTST=0  S ^TMP("BARDME",$J,BARDM,8)=BARHRN_U_BARBILN_U_BARDI_U_"Account/Ins Mismatch",BARERRCT=BARERRCT+1
 ;end new code
 Q
INSCHK1 ;
 ;start old code bar*1.8*22 SDR
 ;I $P(^ABMDBILL(DUZ(2),BARD3P,13,L,0),U,4)'="" D MCR,ERR Q
 ;I $P(^ABMDBILL(DUZ(2),BARD3P,13,L,0),U,5)'="" D RR,ERR Q
 ;I $P(^ABMDBILL(DUZ(2),BARD3P,13,L,0),U,7)'="" D MCD,ERR Q
 ;I $P(^ABMDBILL(DUZ(2),BARD3P,13,L,0),U,8)'="" D PRVT,ERR Q
 ;I TST'=1 S TST=1,^TMP("BARDME",$J,BARDM,7)=BARHRN_U_BARBILN_U_BARDI_U_"Bill Insurer Detail",ERRCT=ERRCT+1
 ;end old code start new code
 I $P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U,4)'="" D MCR,ERR Q
 I $P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U,5)'="" D RR,ERR Q
 I $P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U,7)'="" D MCD,ERR Q
 I $P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U,8)'="" D PRVT,ERR Q
 ;if it gets to here it means there isn't a pointer back to the specific entry in the appropriate eligible file
 ;lets try to figure it out by insurer type
 I "^R^MD^"[("^"_$$GET1^DIQ(9999999.181,$$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".211","I"),1,"I")_"^")&$$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".211","E")["MEDICARE" D MCR,ERR Q
 I "^R^MD^"[("^"_$$GET1^DIQ(9999999.181,$$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".211","I"),1,"I")_"^")&$$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".211","E")["RAILROAD" D RR,ERR Q
 I "^K^"[("^"_$$GET1^DIQ(9999999.181,$$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".211","I"),1,"I")_"^")&($$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".38","I")["P") D PRVT I BARTST=1 D ERR Q
 I "^D^K^"[("^"_$$GET1^DIQ(9999999.181,$$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".211","I"),1,"I")_"^") D MCD I BARTST=1 D ERR Q
 I "^T^C^FPL^F^I^H^MMC^MC^MH^M^N^SEP^TSI^P^"[("^"_$$GET1^DIQ(9999999.181,$$GET1^DIQ(9999999.18,$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U),".211","I"),1,"I")_"^") D PRVT I BARTST=1 D ERR Q
 ;
 I BARTST'=1 S BARTST=1,^TMP("BARDME",$J,BARDM,7)=BARHRN_U_BARBILN_U_BARDI_U_"Bill Insurer Detail",BARERRCT=BARERRCT+1
 ;end new code
 Q
MCR ;EP
 ;S TST=1  ;bar*1.8*22 SDR
 S BARTST=1  ;bar*1.8*22 SDR
 S BARDM("POL_HOLDER")=$P($G(^AUPNMCR(BARDM("PAT_IEN"),21)),U)
 S BARDM("POL_NUM")="MCR"
 S BARDM("POL_DOB")=$P($G(^AUPNMCR(BARDM("PAT_IEN"),21)),U,2)
 S BARDM("MEMBER")=$P($G(^AUPNMCR(BARDM("PAT_IEN"),0)),U,3)
 Q
MCD ;EP
 ;S TST=1  ;bar*1.8*22 SDR
 S BARTST=1  ;bar*1.8*22 SDR
 ;S BARINS=$P(^ABMDBILL(DUZ(2),BARD3P,13,L,0),U,6)  ;bar*1.8*22 SDR
 S BARDINS=$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U,6)  ;bar*1.8*22 SDR
 S:$G(BARDINS)="" BARDINS=$P($G(^ABMDBILL(BARD3PD,BARD3P,0)),U,8)  ;bar*1.8*22 SDR
 I BARDINS="" S BARTST=0 Q  ;bar*1.8*22 SDR
 S BARDM("POL_HOLDER")=$P($G(^AUPNMCD(BARDINS,21)),U)
 S BARDM("POL_NUM")="MCD"
 S BARDM("POL_DOB")=$P($G(^AUPNMCD(BARDINS,21)),U,2)
 S BARDM("MEMBER")=$P($G(^AUPNMCD(BARDINS,0)),U,3)
 Q
RR ;EP
 ;S TST=1  ;bar*1.8*22 SDR
 S BARTST=1  ;bar*1.8*22 SDR
 S BARDM("POL_HOLDER")=$P($G(^AUPNRRE(BARDM("PAT_IEN"),21)),U)
 S BARDM("POL_NUM")="RR"
 S BARDM("POL_DOB")=$P($G(^AUPNRRE(BARDM("PAT_IEN"),21)),U,2)
 S BARDM("MEMBER")=$P($G(^AUPNRRE(BARDM("PAT_IEN"),0)),U,4)
 Q
PRVT ;EP
 ;S TST=1  ;bar*1.8*22 SDR
 S BARTST=1  ;bar*1.8*22 SDR
 ;S BARINS=$P(^ABMDBILL(DUZ(2),BARD3P,13,L,0),U,8)  ;bar*1.8*22 SDR
 S BARINS=$P(^ABMDBILL(BARD3PD,BARD3P,13,BARL,0),U,8)  ;bar*1.8*22 SDR
 I $G(BARINS)="" S BARINS=$P($G(^ABMDBILL(BARD3PD,BARD3P,0)),U,8),BARINS=$O(^AUPNPRVT(BARDM("PAT_IEN"),11,"B",BARINS,0))  ;bar*1.8*22 SDR
 I BARINS="" S BARTST=0 Q  ;bar*1.8*22 SDR
 S BARDM("POL_HOLDER_IEN")=$P($G(^AUPNPRVT(BARDM("PAT_IEN"),11,BARINS,0)),U,8)
 S BARDM("MEMBER")=$P($G(^AUPNPRVT(BARDM("PAT_IEN"),11,BARINS,2)),U)
 I $G(BARDM("POL_HOLDER_IEN")) D
 .S BARDM("POL_HOLDER")=$P(^AUPN3PPH(BARDM("POL_HOLDER_IEN"),0),U)
 .S BARDM("POL_DOB")=$P(^AUPN3PPH(BARDM("POL_HOLDER_IEN"),0),U,19)
 .S BARDM("POL_NUM")=$P(^AUPN3PPH(BARDM("POL_HOLDER_IEN"),0),U,4)
 Q
 ;
ERR ;
 S:BARDM("POL_HOLDER")="" ^TMP("BARDME",$J,BARDM,1)=BARHRN_U_BARBILN_U_BARDI_U_"POLICY HOLDER NAME"
 S:BARDM("POL_NUM")="" ^TMP("BARDME",$J,BARDM,2)=BARHRN_U_BARBILN_U_BARDI_U_"POLICY NUMBER"
 S:BARDM("POL_DOB")="" ^TMP("BARDME",$J,BARDM,3)=BARHRN_U_BARBILN_U_BARDI_U_"POLICY HOLDER DOB"
 S:BARDM("MEMBER")="" ^TMP("BARDME",$J,BARDM,4)=BARHRN_U_BARBILN_U_BARDI_U_"MEMBER NUMBER"
 ;I $D(^TMP("BARDME",$J,BARDM)) S ERRCT=ERRCT+1  ;bar*1.8*22 SDR
 I $D(^TMP("BARDME",$J,BARDM)) S BARERRCT=BARERRCT+1  ;bar*1.8*22 SDR
 Q
 ;
PRINT ;
 D HDR
 ;I $P($G(^TMP("BARDME",$J)),U)=0 W !!," There are not any queued Letters with Errors" S BMCQ=1 Q  ;BAR*1.8*22 SDR
 ;start new code bar*1.8*22 SDR
 I '$D(^TMP("BARDME",$J)) W !!," There are not any queued Letters with Errors",!! S BMCQ=1 D  Q  ;BAR*1.8*22 SDR
 .K DIC,DA,DR,DIR
 .S DIR(0)="E"
 .S DIR("A")="Enter RETURN to Continue"
 .D ^DIR
 ;end new code
 ;S L=0,CT=0  ;bar*1.8*22 SDR
 S BARL=0,BARCT=0  ;bar*1.8*22 SDR
 ;F  S L=$O(^TMP("BARDME",$J,L)) Q:L'?1N.N  D  Q:$G(BARDLQ)  ;bar*1.8*22 SDR
 F  S BARL=$O(^TMP("BARDME",$J,BARL)) Q:BARL'?1N.N  D  Q:$G(BARDLQ)  ;bar*1.8*22 SDR
 .;S CT=CT+1  ;bar*1.8*22 SDR
 .S BARCT=BARCT+1  ;bar*1.8*22 SDR
 .I $Y>(IOSL-6) W ! D RTRN^BARDMU Q:$G(BARDLQ)  D HDR
 .;S L1=0 F  S L1=$O(^TMP("BARDME",$J,L,L1)) Q:L1'?1N.N  D  ;bar*1.8*22 SDR
 .S BARL1=0 F  S BARL1=$O(^TMP("BARDME",$J,BARL,BARL1)) Q:BARL1'?1N.N  D  ;bar*1.8*22 SDR
 ..;W !,$P(^TMP("BARDME",$J,L,L1),U),?8,$E($P(^(L1),U,2),1,8),?20,$P(^(L1),U,3),?60,$P(^(L1),U,4)  ;bar*1.8*22 SDR
 ..W !,$P(^TMP("BARDME",$J,BARL,BARL1),U),?8,$P(^(BARL1),U,2),?30,$E($P(^(BARL1),U,3),1,29),?60,$P(^(BARL1),U,4)  ;bar*1.8*22 SDR
 ;start new code bar*1.8*22 SDR
 W !!
 K DIC,DA,DR,DIR
 S DIR(0)="E"
 S DIR("A")="Enter RETURN to Continue"
 I IOST["C-",'$D(IO("S")) D ^DIR
 ;end new code
 Q
 ;
HDR ;
 ;S PG=PG+1  ;bar*1.8*22 SDR
 S BARPG=BARPG+1  ;bar*1.8*22 SDR
 W @IOF,!,BARRDT,?23,"DEBT MANAGEMENT LETTER ERROR REPORT"
 ;W:$G(BAROPT)'="B" ?70,"PAGE: ",PG  ;bar*1.8*22 SDR
 W:$G(BAROPT)'="B" ?70,"PAGE: ",BARPG  ;bar*1.8*22 SDR
 W !,"A/R PARENT LOCATION: ",BARPNM,!
 F I=1:1:80 W "="
 ;W !?2,"HRN",?8,"BILL NUMBER",?20,"A/R ACCOUNT",?60,"ERROR"  ;bar*1.8*22 SDR
 W !?2,"HRN",?8,"BILL NUMBER",?30,"A/R ACCOUNT",?61,"ERROR"  ;bar*1.8*22 SDR
 W ! F I=1:1:80 W "-"
 Q
