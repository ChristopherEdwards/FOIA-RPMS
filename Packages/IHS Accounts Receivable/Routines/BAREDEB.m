BAREDEB ; IHS/SD/TPF - AR ERA BALANCE CHECKER ; 01/28/2009
 ;;1.8;IHS ACCOUNTS RECEIVABLE;**5,6,10,20**;OCT 26,2005
 ;
 ;THIS RTN CONTAINS THE BALANCE CHECKING NEED SO ERA POSTING DOES NOT ALLOW
 ;POSTING WHICH WILL NOT BE ACCEPTED BY UFMS
 ;
 ;BATCH - CHECKS THE TRANSACTIONS WITHIN A SINGLE ERA FILE BEING POSTED
 ;AGAINST A BATCH. THE PAYMENTS/ADJUSTMENTS FROM THE ERA FILE MUST BE <= THE 
 ;BATCH AMOUNT (#29) AND THE BATCH AMOUNT (#29) MUST BE >=0
 ;
 Q
 ;
 ;TYPE = "ERA" FOR INTERNAL ERA FILE CHECK, RPMS = COMPARE ERA TO RPMS BILL
NEGBAL(IMPDA,TYPE) ;EP - CHECK FOR NEGATIVE BALANCE W/IN ERA AND IF POSTED AGAINST RPMS
 Q:$G(TYPE)=""
 ;I $G(DEBUG) W !!!,"CHECKING FOR NEGATIVE BALANCE IF ERA CLAIMS ARE POSTED..."  ;bar*1.8*20
 I $G(DEBUG) W !!!,"CHECKING FOR NEGATIVE BALANCE IF MATCHED ERA CLAIMS ARE POSTED..."  ;bar*1.8*20
 N BARBILL,BARANS,BARTOT,BARPAY,BARADJ,ADJDA,ERRORS,CHECKTOT,ALLADJ
 N ERACHECK,CLMDA,TCLMDA,CLM,ERRORS,BILLCHOS,BARTYPE,BARREAS
 S (BARBAL,BARTOT,ALLADJ)=0
 K CHECKTOT
 S BARBILL=""
 ;start old code bar*1.8*20 REQ4
 ;F  S BARBILL=$O(^BAREDI("I",DUZ(2),IMPDA,30,"B",BARBILL)) Q:BARBILL=""  D
 ;end old code start new code REQ4
 K BARCNT,BARAMT,BARTOT  ;bar*1.8*20
 S CLMCNT=0
 S CLMDA=0
 K ^XTMP("BAR-LIST",$J,DUZ(2))
 F  S CLMDA=$O(^BAREDI("I",DUZ(2),"F",BARCHK,IMPDA,CLMDA)) Q:'CLMDA  D
 .S BARBILL=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U)
 .S ^XTMP("BAR-LIST",$J,DUZ(2),BARBILL,CLMDA)=""
 S BARBILL=""
 F  S BARBILL=$O(^XTMP("BAR-LIST",$J,DUZ(2),BARBILL)) Q:BARBILL=""  D
 .S CLMCNT=+$G(CLMCNT)+1  ;bar*1.8*20 REQ4
 .;end new code REQ4
 .S BARPAY=0
 .;I $G(DEBUG) W !!?10,"ERA BILL: ",BARBILL  ;bar*1.8*20 REQ4
 .;WAS A BILL CHOSEN OR MATCHED EARLIER IN BAREDP04?
 .S CLMDA=0,BILLCHOS=""
 .F  S CLMDA=$O(^BAREDI("I",DUZ(2),IMPDA,30,"B",BARBILL,CLMDA)) Q:'CLMDA!(BILLCHOS'="")  D
 ..S BILLCHOS=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,1)),U)  ;A-CLAIM ; IF THIS IS POPULATED THEN THE CORRCET BILL WAS FOUND OR CHOSEN ALREADY
 ..S BARSTAT=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,2)  ;bar*1.8*20 REQ5
 ..S BARTOT("CNT")=+$G(BARTOT("CNT"))+1,BARTOT("AMT")=+$G(BARTOT("AMT"))+$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,4) ;bar*1.8*20
 ..I BARSTAT="M" S BARCNT("MATCHED")=+$G(BARCNT("MATCHED"))+1,BARAMT("MATCHED")=+$G(BARAMT("MATCHED"))+$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,4)  ;bar*1.8*20
 ..I BARSTAT'="M" S BARCNT("UNMATCHED")=+$G(BARCNT("UNMATCHED"))+1,BARAMT("UNMATCHED")=+$G(BARAMT("UNMATCHED"))+$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,4)  ;bar*1.8*20
 .Q:BARSTAT'="M"  ;only display matched claims bar*1.8*20
 .I $G(DEBUG) W !!,CLMCNT,?4,"ERA BILL: ",BARBILL  ;bar*1.8*20 REQ4
 .I BILLCHOS S BARBLIEN=BILLCHOS
 .E  S BARBLIEN=$$GETIEN("B",BARBILL)
 .I BARBLIEN="BILL NOT FOUND" D
 ..S CLMDA=$O(^BAREDI("I",DUZ(2),IMPDA,30,"B",BARBILL,""))
 ..I '$D(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,4,"B",11)) D
 ...S ERRORS("BL NF")=""  ;BILL NOT FOUND IN RPMS. SET ONLY IF OLD ERROR 11 NOT SET
 .I BARBLIEN="DUPLICATE BILLS FOUND" D
 ..S ERRORS("DUPB")=""  ;DUPLICATE BILLS FOUND IN RPMS
 .I BARBLIEN S BARBAL=$$GET1^DIQ(90050.01,BARBLIEN_",",15,"I")  ;CURRENT BILL AMOUNT
 .E  S BARBAL=0
 .;I $G(DEBUG) W !?15,"CURRENT BILL AMOUNT (RPMS):",BARBAL  ;bar*1.8*20 REQ4
 .I $G(DEBUG) W ?41,"CURRENT BILL AMT(RPMS): ",$J($FN(BARBAL,",",2),14)  ;bar*1.8*20 REQ4
 .;
 .S BARADJ=0
 .S CLMDA=""
 .F  S CLMDA=$O(^BAREDI("I",DUZ(2),IMPDA,30,"B",BARBILL,CLMDA)) Q:CLMDA=""  D
 ..;Q:$D(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,4,"B",44))  ;DON'T PROCESS USER STATUS OVVERRIDE BAR*1.8*6 SCR120
 ..Q:$$OVERIDE^BAREDEP1(CLMDA)                         ;MRS:BAR*1.8*10 D159-1 AND 2
 ..Q:$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,2)="P"  ;DON'T PROCESS POSTED CLAIMS
 ..S CLSTATUS=$P($P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,11)," ")  ;E-CLAIM STATUS CODE (CLP02)
 ..I CLSTATUS="" S CLSTATUS=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,2)),U,4)  ;MRS:BAR*1.8*10 H2555
 ..;Q:(U_"1"_U_"2"_U_"3"_U_"19"_U_"20"_U_"21"_U_"22"_U)'[(U_CLSTATUS_U)  ;PRIMARY,SECONDARY,TERTIARY AS WELL AS THOSE 19,20,21 FORWARDED TO ADDITIONAL PAYER BAR*1.8*6 IM29637
 ..Q:(U_"1"_U_"2"_U_"3"_U_"4"_U_"19"_U_"20"_U_"21"_U_"22"_U)'[(U_CLSTATUS_U)  ;ADDED 4 (DENIALS) PER EMAIL OF 7/31
 ..;DENIAL ADJUSTMENTS CLP02=4 WERE CREATING NEGATIVE BALANCES
 ..S ERACHECK=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,2)),U)
 ..S BARAMT=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,4)
 ..S BARPAY=BARPAY+BARAMT
 ..;I $G(DEBUG) W !?20,"PAYMENT: ",BARAMT  ;bar*1.8*20 REQ4
 ..I $G(DEBUG) W !?59,"PYMT: ",$J($FN(BARAMT,",",2),14)  ;bar*1.8*20 REQ4
 ..;
 ..S CHECKTOT(ERACHECK)=$G(CHECKTOT(ERACHECK))+BARAMT
 ..S ADJDA=0
 ..F  S ADJDA=$O(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,30,ADJDA)) Q:'+ADJDA  D
 ...S BARAMT=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,30,ADJDA,0)),U,2)
 ...S BARCAT=$$GET1^DIQ(90056.0208,ADJDA_","_CLMDA_","_IMPDA_",",.04,"E")
 ...S BARREAS=$$GET1^DIQ(90056.0208,ADJDA_","_CLMDA_","_IMPDA_",",.05,"E")
 ...;start old code bar*1.8*20 REQ4
 ...;I $G(DEBUG) W !?25,"ADJUSTMENT: ",BARAMT
 ...;I $G(DEBUG) W ?55,"A/R CAT: ",BARCAT
 ...;I $G(DEBUG) W !?55,"A.R REASON: ",BARREAS
 ...;end old code start new code REQ4
 ...I $G(DEBUG) W !?3,"A/R CAT:",$E(BARCAT,1,11)
 ...I $G(DEBUG) W ?23,"A/R RSN:",$E(BARREAS,1,27)
 ...I $G(DEBUG) W ?60,"ADJ:",$J($FN(BARAMT,",",2),15)
 ...;end new code REQ4
 ...S BARADJ=BARADJ+BARAMT
 ...S ALLADJ=ALLADJ+BARAMT
 .S BARTOT=BARPAY+BARADJ
 .I $G(DEBUG) W !,?28,"BILL BALANCE IF ERA CLAIM IS POSTED: ",$J($FN(BARBAL-BARTOT,",",2),14)
 .I BARBAL-BARTOT<0 D
 ..Q:BARSTAT'="M"!($D(ERRORS("DUPB")))  ;don't put error on claim if not matched or if duplicate bills  bar*1.8*20 REQ5
 ..S ERRORS("NEGR")=""
 .I $D(ERRORS) D
 ..S TCLMDA=""
 ..F  S TCLMDA=$O(^BAREDI("I",DUZ(2),IMPDA,30,"B",BARBILL,TCLMDA)) Q:TCLMDA=""  D
 ...;Q:$D(^BAREDI("I",DUZ(2),IMPDA,30,TCLMDA,4,"B",44))  ;DON'T PROCESS USER STATUS OVVERRIDE BAR*1.8*6 SCR120
 ...Q:$$OVERIDE^BAREDEP1(TCLMDA)                         ;MRS:BAR*1.8*10 D159-1 AND 2
 ...Q:$P($G(^BAREDI("I",DUZ(2),IMPDA,30,TCLMDA,0)),U,2)="P"  ;DON'T PROCESS POSTED CLAIMS
 ...S CLSTATUS=$P($P($G(^BAREDI("I",DUZ(2),IMPDA,30,TCLMDA,0)),U,11)," ")  ;E-CLAIM STATUS CODE (CLP02) BAR*1.8*6 IM29637
 ...I CLSTATUS="" S CLSTATUS=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,2)),U,4)  ;MRS:BAR*1.8*10
 ...;Q:(U_"1"_U_"2"_U_"3"_U_"19"_U_"20"_U_"21"_U_"22"_U)'[(U_CLSTATUS_U)  ;PRIMARY,SECONDARY,TERTIARY AS WELL AS THOSE 19,20,21 FORWARDED TO ADDITIONAL PAYER BAR*1.8*6 IM29637
 ...Q:(U_"1"_U_"2"_U_"3"_U_"4"_U_"19"_U_"20"_U_"21"_U_"22"_U)'[(U_CLSTATUS_U)  ;ADDED 4 (DENIALS) PER EMAIL/CONVERSATION WITH ADRIAN 7/31
 ...D ADDREAS^BAREDP04(IMPDA,TCLMDA,.ERRORS)
 .K ERRORS
 D CHECKTOT(.CHECKTOT) ;CHECK ERA CHECK TOTALS AGAINST BATCH/ITEM TOTAL
 Q
 ;
CHECKTOT(CHECKTOT) ;CHECK ERA CHECK TOTALS AGAINST BATCH/ITEM TOTAL
 N ERRORS,CLMDA,ALLPAY,ERACHECK,CLSTATUS
 N BPR02  ;BAR*1.8*6 SCR119 IHS/SD/TPF
 S ERACHECK=""
 ;start new code bar*1.8*20 REQ4
 W !
 W !?2,"  Matched Bills: ",$J(+$G(BARCNT("MATCHED")),5)," for $",$J($FN(+$G(BARAMT("MATCHED")),",",2),12)
 W !?2,"Unmatched Bills: ",$J(+$G(BARCNT("UNMATCHED")),5)," for $",$J($FN(+$G(BARAMT("UNMATCHED")),",",2),12)
 W !?2,"    Total Bills: ",$J(+$G(BARTOT("CNT")),5)," for $",$J($FN(+$G(BARTOT("AMT")),",",2),12)
 W !
 ;end new code REQ4
 F  S ERACHECK=$O(CHECKTOT(ERACHECK)) Q:ERACHECK=""  D
 .S CLMDA=""
 .S CLMDA=$O(^BAREDI("I",DUZ(2),"F",ERACHECK,IMPDA,CLMDA))
 .S BPR02=+$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,2)),U,5)  ;BPR MONETARY AMOUNT BAR*1.8*6 SCR119 IHS/SD/TPF
 .;I $G(DEBUG) W !!,"CHECKING ERA CHECK TOTALS FOR ",ERACHECK,"   TOTAL",CHECKTOT(ERACHECK)  ;bar*1.8*20 REQ4
 .I $G(DEBUG) W !?2,"CHECKING ERA CHECK TOTALS FOR ",ERACHECK,"   TOTAL ",$J($FN(CHECKTOT(ERACHECK),",",2),15)  ;bar*1.8*20 REQ4
 .;
 .;D GETITMTO(ERACHECK,CHECKTOT(ERACHECK),.ERRORS)  ;GET BATCH/ITEM TOTAL
 .D GETITMTO(ERACHECK,CHECKTOT(ERACHECK),.ERRORS,BPR02)  ;GET BATCH/ITEM TOTAL  BAR*1.8*6 SCR119 IHS/SD/TPF
 .I $D(ERRORS) D
 ..S CLMDA=""
 ..F  S CLMDA=$O(^BAREDI("I",DUZ(2),"F",ERACHECK,IMPDA,CLMDA)) Q:CLMDA=""  D
 ...;Q:$D(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,4,"B",44))  ;DON'T PROCESS USER STATUS OVVERRIDE BAR*1.8*6 SCR120
 ...Q:$$OVERIDE^BAREDEP1(CLMDA)                         ;MRS:BAR*1.8*10 D159-1 AND 2
 ...Q:$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,2)="P"  ;DON'T PROCESS POSTED CLAIMS
 ...S CLSTATUS=$P($P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,0)),U,11)," ")  ;E-CLAIM STATUS CODE (CLP02) BAR*1.8*6 IM29637
 ...I CLSTATUS="" S CLSTATUS=$P($G(^BAREDI("I",DUZ(2),IMPDA,30,CLMDA,2)),U,4)  ;MRS:BAR*1.8*10
 ...;Q:(U_"1"_U_"2"_U_"3"_U_"19"_U_"20"_U_"21"_U_"22"_U)'[(U_CLSTATUS_U)  ;PRIMARY,SECONDARY,TERTIARY AS WELL AS THOSE 19,20,21 FORWARDED TO ADDITIONAL PAYER BAR*1.8*6 IM29637
 ...Q:(U_"1"_U_"2"_U_"3"_U_"4"_U_"19"_U_"20"_U_"21"_U_"22"_U)'[(U_CLSTATUS_U)  ;ADDED 4 (DENIALS) PER EMAIL/CONVERSATION WITH ADRIAN 7/31
 ...D ADDREAS^BAREDP04(IMPDA,CLMDA,.ERRORS)
 .K ERRORS
 Q
 ;
GETIEN(BARX,BARBILL) ;EP - FIND AR BILL IEN
 N BARTMP
 S (BARBIEN,BARCNT)=0
 I '$D(^BARBL(DUZ(2),"B",BARBILL)) S BARX="G"   ; Pharmacy POS
 F  S BARBIEN=$O(^BARBL(DUZ(2),BARX,BARBILL,BARBIEN)) Q:'+BARBIEN  D
 . S BARCNT=BARCNT+1
 . S BARTMP(BARBIEN)=""
 I BARCNT=0 Q "BILL NOT FOUND"          ;BILL NOT FOUND IN RPMS
 I BARCNT>1 Q "DUPLICATE BILLS FOUND"   ;DUPES FOUND
 S BARBIEN=$O(BARTMP(""))
 Q BARBIEN
 ;
 ;GETITMTO(ERACHECK,ERATOTAL,ERRORS) ;EP - GIVEN ERACHECK GET BATCH ITEM TOTALS FOR ERA CHECK
GETITMTO(ERACHECK,ERATOTAL,ERRORS,BRP02) ;EP - GIVEN ERACHECK GET BATCH ITEM TOTALS FOR ERA CHECK ;BAR*1.8*6 SCR119 IHS/SD/TPF
 N BARCOLDA,BARITMDA,ITEMTOT
 ;S ITEMTOT=0
 S BPOSTBAL=0  ;BAR*1.8*6
 S BARCOLDA=$O(^BARCOL(DUZ(2),"D",ERACHECK,""))
 I 'BARCOLDA,(BPR02=0) Q  ;BAR*1.8*6 SCR119 DON'T REQUIRE A BATCH NONPAY CHECK FOR A BPR02=0 IHS/SD/TPF
 I 'BARCOLDA D  Q
 .S ERRORS("NB")=""  ;NO BATCH FOUND FOR ERA CHECK
 S BARCOLDA=""
 W !  ;bar*1.8*20 REQ4
 F  S BARCOLDA=$O(^BARCOL(DUZ(2),"D",ERACHECK,BARCOLDA)) Q:BARCOLDA=""  D
 .;I $G(DEBUG) W !,?10,"CHECKING BATCH: ",$P($G(^BARCOL(DUZ(2),BARCOLDA,0)),U)  ;bar*1.8*20 REQ4
 .I $G(DEBUG) W !,?2,"CHECKING BATCH: ",$P($G(^BARCOL(DUZ(2),BARCOLDA,0)),U)  ;bar*1.8*20 REQ4
 .;
 .S BPOSTBAL=BPOSTBAL+$$GET1^DIQ(90051.01,BARCOLDA_",",17,"E")  ;BAR*1.8*6 LOOK AT BATCH POSTING TOTAL NOT ITEM CREDIT TOTALS
 .;S BARITMDA=""
 .;F  S BARITMDA=$O(^BARCOL(DUZ(2),"D",ERACHECK,BARCOLDA,BARITMDA)) Q:BARITMDA=""  D
 .;.I $G(DEBUG) W !?15,"ITEM: ",BARITMDA
 .;.I $P($G(^BARCOL(DUZ(2),BARCOLDA,1,BARITMDA,0)),U,17)="C"!($P($G(^BARCOL(DUZ(2),BARCOLDA,1,BARITMDA,0)),U,17)="R") D  Q  ;MO CANCELLED OR ROLLED UP ITEMS
 .;..I $G(DEBUG) W "  ITEM CANCELLED OR ROLLED UP - NOT COUNTING"
 .;.I $G(DEBUG) W !?25,"CREDIT: ",$P($G(^BARCOL(DUZ(2),BARCOLDA,1,BARITMDA,1)),U)
 .;.S ITEMTOT=ITEMTOT+$P($G(^BARCOL(DUZ(2),BARCOLDA,1,BARITMDA,1)),U)  ;CREDIT
 .;.;S ITEMTOT=ITEMTOT+$$GET1^DIQ(90051.1101,102.5,"E")
 .I $G(DEBUG) W !?25,"BATCH POSTING BALANCE: ",BPOSTBAL
 ;I ERATOTAL>ITEMTOT D
 I ERATOTAL>BPOSTBAL D
 .S ERRORS("ERA > ITM")=""  ;ERA TOTAL GREATER THAN BATCH/ITEM TOTAL
 .I $G(DEBUG) W !,"ERA TOTAL PAYMENTS AND ADJUSTMENTS OF ",ERATOTAL
 .;I $G(DEBUG) W !,"IS GREATER THAN BATCH ITEM TOTAL OF ",ITEMTOT
 .I $G(DEBUG) W !,"IS GREATER THAN BATCH POSTING BALANCE OF ",BPOSTBAL
 Q
