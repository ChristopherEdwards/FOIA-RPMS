BARRSLDX ; IHS/SD/LSL - Utility to selec DX Parameters
 ;;1.8;IHS ACCOUNTS RECEIVABLE;**23**;OCT 26,2005
 ; JUN 2013 P.OTTIS - MOD FOR ICD9/10 DX - NEW ROUTINE
 ; SEP 2013 P.OTTIS BUG FIX NOT SETING DX("P") CORRECTLY
 ; *********************************************************************
 ;
DXTYPE ;
 K BARY("DXTYPE")
 K DIRUT,DIR,Y
 S Y=$$DIR^XBDIR("S^P:Search in Primary DX Only;A:All DX","Select Search DX type ","","","","",1)
 K DA
 Q Y
 ;
GETDX(BARIEN) ;
 ;
 ; Search ALL diagnosis; fill array BARARRDG
 ; BAR3PDXP=1 indicates primary DX
 ; 
 NEW BARDBG,BARCNT,BAR3PDX,BARPRMDX,BAR3PDXP,BAR3PLOC,BAR3PIEN,BAR3PDUZ,BARARRDG,I ;ARRAY OF DG
 S BARDBG=0 ;P.OTT
 ;;;I BARDBG W !,"DUZ(2)=",DUZ(2)," BILL IEN=",BAR
 ;
 S BAR3PLOC=$$FIND3PB^BARUTL(DUZ(2),BARIEN)
 I BAR3PLOC="" Q
 S BAR3PIEN=$P(BAR3PLOC,",",2)
 S BAR3PDUZ=$P(BAR3PLOC,",")
 S BARCNT=0
 S (BAR3PDX,BARPRMDX)=0 F  S BAR3PDX=$O(^ABMDBILL(BAR3PDUZ,BAR3PIEN,17,BAR3PDX)) Q:'+BAR3PDX  D  ;Q:+BARPRMDX
 . S BARCNT=BARCNT+1
 . S BAR3PDXP=$P($G(^ABMDBILL(BAR3PDUZ,BAR3PIEN,17,BAR3PDX,0)),U,2)
 . I $T(+1^ICDEX)="" S BARDXCOD=$P($$ICDDX^ICDCODE(BAR3PDX,""),U,2) ;DX CODE - OLD CODE: NOT WORKING FOR ICD10
 . I $T(+1^ICDEX)]"" S BARDXCOD=$P($$ICDDX^ICDEX(BAR3PDX,""),U,2) ;DX CODE - NEW API SUPPORTS BOTH ICD9/10
 . I BAR3PDXP=1 I BARY("DXTYPE")="P" S BARARRDG("ALL_CODE",BARCNT)=BARDXCOD Q  ;
 . ;;;I DUZ=838 W !,BARCNT,".  ",^ABMDBILL(BAR3PDUZ,BAR3PIEN,17,BAR3PDX,0),"  ",BAR3PDXP," CODE=",BARDXCOD R ASD
 . S BARARRDG("ALL_CODE",BARCNT)=BARDXCOD
 . Q
 K BAR("DX") ;clear array
 ;;;I $G(BARY("DXTYPE"))="P" S BAR("DX")="P" ;BUG FIX P.OTT SEP 2013
 ;;;I $G(BARY("DXTYPE"))="A"!($G(BARY("DXTYPE"))="O") S BAR("DX")="O"
 M BAR("DX")=BARARRDG("ALL_CODE") ;fill array
 ;;;I BARDBG S I="" F  S I=$O(BAR("DX",I)) Q:I=""  W ?30," ",I,". ",BAR("DX",I) W !
 Q
 ;COUNT DXs WHICH CONTAIN X
 ;
LIST(BARX,BARVERB) ;
 NEW BARX0,BARXL
 ;RETURNS : BARCNT
 S BARXL=$L(X),BARCNT=0,BARX0=X_" "
 F I=1:1 S BARX0=$O(^ICD9("AB",BARX0)) Q:BARX0=""  Q:$E(BARX0,1,BARXL)'=BARX  D
 . S BARCNT=BARCNT+1
 . I BARVERB W !,BARCNT,". ",BARX0
 I 'BARVERB Q
 I 'BARCNT W " NO MATCHING DXs." Q
 W "  ",BARCNT," MATCHING DXs FOUND."
 Q
