BGP4D61 ; IHS/CMI/LAB - indicator 31 ;
 ;;7.0;IHS CLINICAL REPORTING;;JAN 24, 2007
 ;
I15 ;EP
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5,BGPN6,BGPD1,BGPD2,BGPD3,BGPD4,BGPD5,BGPD6,BGPD7,BGPD8,BGPD9)=0
 I BGPAGEB<52 S BGPSTOP=1 Q
 S BGPD1=1
 S BGPFOB=$$FOB(DFN,BGPEDATE)
 S BGPRECT=$$RECT(DFN,BGPEDATE)
 I BGPFOB]"" S BGPN2=1,BGPN1=1
 I BGPRECT]"" S BGPN3=1,BGPN1=1
 S BGPOTH=""
 I BGPN1=0 S BGPOTH=$$IBH(DFN,BGPEDATE)
 I BGPOTH]"" S BGPN1=1
 S BGPVALUE=$S(BGPFOB]"":BGPFOB,BGPRECT]"":BGPRECT,1:BGPOTH),BGPVALUE=$P(BGPVALUE,U,2)_" "_$P(BGPVALUE,U)
 S BGPDV=$S(BGPD1:"UP",1:"")_$S(BGPACTCL:",AC",1:"")
 S BGPVALUE=BGPDV_";"_BGPVALUE
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P
 Q
IBH(P,EDATE) ;EP
 NEW VALUE
 S VALUE=""
 S VALUE=$$SIG(P,EDATE)
 I VALUE]"" Q VALUE
 S VALUE=$$BE(P,EDATE)
 I VALUE]"" Q VALUE
 S VALUE=$$COLO(P,EDATE)
 I VALUE]"" Q VALUE
 ;refusal
 S G=$$REFUSAL^BGP4UTL1(P,9999999.15,$O(^AUTTEXAM("B","RECTAL EXAM",0)),$$FMADD^XLFDT(EDATE,-365),EDATE)
 I $P(G,U)=1 Q "REFUSED"_$P(G,U,2)
 Q ""
RECT(P,EDATE) ;EP
 S BDATE=$$FMADD^XLFDT(EDATE,2*(-365))
 K BGPG
 S %=P_"^LAST EXAM RECTAL;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "RECTAL EXAM"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S %=P_"^LAST DIAGNOSIS V76.41;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "RECT DX V76.41"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 K BGPG S %=P_"^LAST PROCEDURE BGP RECTAL PROCEDURE CODES;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "DRE VPRC"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 Q ""
SIG(P,EDATE) ;
 S BDATE=$$FMADD^XLFDT(EDATE,5*(-365))
 K BGPG S %=P_"^LAST PROCEDURE 45.22;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "SIG 45.22"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 K BGPG S %=P_"^LAST PROCEDURE 45.24;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "SIG 45.24"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 K BGPG S %=P_"^LAST PROCEDURE 45.42;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "SIG 45.42"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S T=$O(^ATXAX("B","BGP SIG CPTS",0))
 I T D  I X]"" Q "CPT SIG"_U_$$DATE^BGP4UTL(X)
 .S X=$$CPT^BGPDU(P,BDATE,EDATE,T,3)
 S %=P_"^LAST PROCEDURE 48.21;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "SIG 48.21"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S %=P_"^LAST PROCEDURE 48.22;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "SIG 48.22"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S %=P_"^LAST PROCEDURE 48.23;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "SIG 48.23"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S %=P_"^LAST PROCEDURE 48.24;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "SIG 48.24"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 Q ""
COLO(P,EDATE) ;
 K BGPG
 S BDATE=$$FMADD^XLFDT(EDATE,10*(-365))
 S %=P_"^LAST DIAGNOSIS V76.51;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "COLO DX V76.51"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S %=P_"^LAST PROCEDURE 45.21;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "COLO 45.21"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S %=P_"^LAST PROCEDURE 45.23;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "COLO 45.23"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S %=P_"^LAST PROCEDURE 45.25;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "COLO 45.25"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 S T=$O(^ATXAX("B","BGP COLO CPTS",0))
 I T D  I X]"" Q "CPT COLO"_U_$$DATE^BGP4UTL(X)
 .S X=$$CPT^BGPDU(P,BDATE,EDATE,T,3)
 Q ""
FOB(P,EDATE) ;EP
 S BDATE=$$FMADD^XLFDT(EDATE,2*(-365))
 S BGPC=""
 S T=$O(^ATXAX("B","BGP FOBT LOINC CODES",0))
 S BGPLT=$O(^ATXLAB("B","BGP GPRA FOB TESTS",0))
 S B=9999999-BDATE,E=9999999-EDATE S D=E-1 F  S D=$O(^AUPNVLAB("AE",P,D)) Q:D'=+D!(D>B)!(BGPC]"")  D
 .S L=0 F  S L=$O(^AUPNVLAB("AE",P,D,L)) Q:L'=+L!(BGPC]"")  D
 ..S X=0 F  S X=$O(^AUPNVLAB("AE",P,D,L,X)) Q:X'=+X!(BGPC]"")  D
 ...Q:'$D(^AUPNVLAB(X,0))
 ...I BGPLT,$P(^AUPNVLAB(X,0),U),$D(^ATXLAB(BGPLT,21,"B",$P(^AUPNVLAB(X,0),U))) S BGPC="FOB V LAB"_U_$$DATE^BGP4UTL((9999999-D)) Q
 ...Q:'T
 ...S J=$P($G(^AUPNVLAB(X,11)),U,13) Q:J=""
 ...Q:'$$LOINC(J,T)
 ...S BGPC="FOB LOINC"_U_$$DATE^BGP4UTL((9999999-D)) Q
 ...Q
 I BGPC]"" Q BGPC
 S E=+$$CODEN^ICPTCOD(82270) I E S %=$$CPTI^BGPDU(P,BDATE,EDATE,E) I $P(%,U)=1 Q "FOB CPT 82270"_"^"_$$DATE^BGP4UTL($P(%,U,2))
 S E=+$$CODEN^ICPTCOD(82274) I E S %=$$CPTI^BGPDU(P,BDATE,EDATE,E) I $P(%,U)=1 Q "FOB CPT 82274"_"^"_$$DATE^BGP4UTL($P(%,U,2))
 S E=+$$CODEN^ICPTCOD(89205) I E S %=$$CPTI^BGPDU(P,BDATE,EDATE,E) I $P(%,U)=1 Q "FOB CPT 89205"_"^"_$$DATE^BGP4UTL($P(%,U,2))
 S E=+$$CODEN^ICPTCOD("G0107") I E S %=$$CPTI^BGPDU(P,BDATE,EDATE,E) I $P(%,U)=1 Q "FOB CPT G0107"_"^"_$$DATE^BGP4UTL($P(%,U,2))
 Q ""
BE(P,EDATE) ;EP
 S BDATE=$$FMADD^XLFDT(EDATE,5*(-365))
 K BGPG S %=P_"^LAST PROCEDURE 87.64;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE),E=$$START1^APCLDF(%,"BGPG(")
 I $D(BGPG(1)) Q "BE 87.64"_"^"_$$DATE^BGP4UTL($P(BGPG(1),U))
 K BGPG S R="" F %=1:1 S T=$T(BECPTS+%^BGPDU) Q:$P(T,";;",2)=""!(R)  S T=$P(T,";;",2),T=+$$CODEN^ICPTCOD(T) I T S E=$$CPTI^BGPDU(P,BDATE,EDATE,T) I E S R=1 S V="BE CPT "_T_"^"_$$DATE^BGP4UTL($P(E,U,2))
 I R Q V
 S (X,Y,V)=0,G="" F  S X=$O(^AUPNVRAD("AC",P,X)) Q:X'=+X!(G]"")  D
 .S V=$P(^AUPNVRAD(X,0),U,3),V=$P($P($G(^AUPNVSIT(V,0)),U),".")
 .Q:V>EDATE
 .Q:V<BDATE
 .S Y=$P(^AUPNVRAD(X,0),U),Y=$P($G(^RAMIS(71,Y,0)),U,9)
 .Q:Y=""
 .S Y=$P($$CPT^ICPTCOD(Y),U,2)
 .I Y=74280 S G="1^"_V_"^74280" Q
 .I Y=74270 S G="1^"_V_"^74270" Q
 .I Y=74275 S G="1^"_V_"^74275" Q
 .Q
 Q G
 ;
LOINC(A,B) ;
 NEW %
 S %=$P($G(^LAB(95.3,A,9999999)),U,2)
 I %]"",$D(^ATXAX(B,21,"B",%)) Q 1
 S %=$P($G(^LAB(95.3,A,0)),U)_"-"_$P($G(^LAB(95.3,A,0)),U,15)
 I $D(^ATXAX(B,21,"B",%)) Q 1
 Q ""
