BGP5EL3 ; IHS/CMI/LAB - indicator 1,2,3,4 05 Apr 2005 1:44 PM ;
 ;;7.0;IHS CLINICAL REPORTING;;JAN 24, 2007
 ;
I9 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPVALUE=$$FLU^BGP5D3(DFN,BGPEDATE) ;set to date of flu shot
 S BGPN1=0 I BGPVALUE]"" S BGPN1=1
 S BGPN2=0 I BGPVALUE["Refus" S BGPN2=1
 S BGPVALUE="AC"_"|||"_BGPVALUE
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,J,K,G,I,L,T
 K BGPX,BGPY,BGPC,BGPG
 Q
I10 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPVALUE=$$PNEU^BGP5D31(DFN,$$DOB^AUPNPAT(DFN),BGPEDATE) ;set to date of PNEU shot
 S BGPN1=0 I BGPVALUE]"" S BGPN1=1
 S BGPN2=0 I BGPVALUE["Refus" S BGPN2=1
 S BGPVALUE="AC"_"|||"_BGPVALUE
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,J,K,G,I,L,T,BGPLHGB
 K BGPUP,BGPGFR,BGPX,BGPY,BGPC,BGPG
 Q
I11 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 I $P(^DPT(DFN,0),U,2)'="F" S BGPSTOP=1 Q
 I $$MAS^BGP5D4(DFN,BGPEDATE) S BGPSTOP=1 Q  ;had mastectomy
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPMAM=$$MAM^BGP5D4(DFN,BGPEDATE,2)
 S BGPN1=0 I $P(BGPMAM,U)=1 S BGPN1=1
 S BGPN2=0 I $P(BGPMAM,U,3)="ref" S BGPN2=1
 S BGPVALUE="AC"_"|||"_$$DATE^BGP5UTL($P(BGPMAM,U,2))_" "_$P(BGPMAM,U,3)
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,J,K,G,I,L,T,BGPLHGB
 K BGPUP,BGPGFR,BGPX,BGPY,BGPC,BGPG,BGPMAM
 Q
I12 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 I $$CRC^BGP5D61(DFN,BGPEDATE) S BGPSTOP=1 Q  ;has colorectal cancer
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPFOB=$$FOB^BGP5D61(DFN,BGPEDATE)
 S BGPRECT=$$RECT^BGP5D61(DFN,BGPEDATE)
 I BGPFOB]"" S BGPN3=1,BGPN1=1
 I BGPRECT]"" S BGPN4=1
 S BGPOTH=""
 I BGPN1=0 S BGPOTH=$$IBH^BGP5D61(DFN,BGPEDATE)
 I BGPOTH]"" S BGPN1=1
 S BGPREF="" I 'BGPN1 S BGPREF=$$REF^BGP5D61(DFN,$$FMADD^XLFDT(BGPEDATE,-365),BGPEDATE) I BGPREF S BGPN1=1,BGPN2=1
 S BGPVALUE=""
 I BGPFOB]"" S BGPVALUE=$P(BGPFOB,U)_":"_$P(BGPFOB,U,2)_" "
 I BGPRECT]"" S BGPVALUE=BGPVALUE_$P(BGPRECT,U)_":"_$P(BGPRECT,U,2)_" "
 I BGPOTH]"" S BGPVALUE=BGPVALUE_$P(BGPOTH,U)_":"_$P(BGPOTH,U,2)_" "
 I BGPREF]"" S BGPVALUE=BGPVALUE_$P(BGPREF,U,3)_":"_$$DATE^BGP5UTL($P(BGPREF,U,2))
 S BGPDV="AC"
 S BGPVALUE=BGPDV_"|||"_BGPVALUE
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P
 K BGPX,BGPY,BGPC,BGPG
 Q
I13 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPTOB=$$TOBACCO^BGP5D7(DFN,BGP365,BGPEDATE)
 S BGPN1=$S(BGPTOB]"":1,1:0)
 S BGPSDX=$$DX^BGP5D7(DFN,BGP365,BGPEDATE)
 S BGPXPED=$$PED^BGP5D7(DFN,BGP365,BGPEDATE)
 S BGP1320=$$DENT^BGP5D7(DFN,BGP365,BGPEDATE)
 I BGPSDX]"" S BGPN1=1
 I BGPXPED]"" S BGPN1=1
 I BGP1320]"" S BGPN1=1
 S F=$P(BGPTOB,U)
 I F["CURRENT"!(BGPSDX]""&(+BGPSDX'="305.13"))!(BGP1320]"") S BGPN2=1
 I F["CURRENT SMOKER"!(BGPSDX]""&(+BGPSDX'="305.13"))!(BGP1320]"") S BGPN3=1
 I F="CURRENT SMOKELESS"!(F="CURRENT SMOKER & SMOKELESS") S BGPN4=1
 ;I BGPN2,BGPXPED]"" S BGPN5=1
 I F="SMOKER IN HOME"!(F["ENVIRON") S BGPN5=1
 S V="AC"
 S V=V_"|||"
 S S=$S(F="CURRENT SMOKER":"Cur Smk",F="CURRENT SMOKELESS":"Cur smkl",F["NON":"NTU",F="CURRENT SMOKER & SMOKELESS":"Cur smk/smkl",F["SMOKER IN HOME":"Smk Home",F["ENVIRON":"ETS",1:"")
 I S="" S S=$S(F="PREVIOUS SMOKER":"Prev smk",F="PREVIOUS SMOKELESS":"Prev smkl",F["PREVIOUS":"Prev smk/smkl",F="SMOKE FREE HOME":"Smk free home",F["ENVIRON":"Exposed to ETS",1:"")
 I S="" S S=F
 I S]"" S S="HF "_S_" "_$P(BGPTOB,U,2)
 I BGP1320]"" S S=S_" 1320 ADA "_$$DATE^BGP5UTL($P(BGP1320,U,2))
 I BGPSDX]"" S S=S_" DX "_$S($P(BGPSDX,U,1)="305.13":"quit",1:"Cur smk")_" "_$$DATE^BGP5UTL($P(BGPSDX,U,2))
 I BGPXPED]"" S S=S_" PtEd "_$P(BGPXPED,U)_" "_$$DATE^BGP5UTL($P(BGPXPED,U,2))
 S BGPVALUE=V_" "_S
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,BGPSDX,BGPXPED,BGP1320
 K BGPX,BGPY,BGPC,BGPG
 Q
I14 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 S BGPDVREF=""
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 I BGPSEX'="F" S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPDVEX=$$DVEX^BGP5D5(DFN,BGP365,BGPEDATE) I $P(BGPDVEX,U)=1 S BGPN2=1
 S BGPDVDX=$$DVDX^BGP5D5(DFN,BGP365,BGPEDATE) I $P(BGPDVDX,U)=1 S BGPN3=1
 S BGPDVPED=$$DVPED^BGP5D5(DFN,BGP365,BGPEDATE) I $P(BGPDVPED,U)=1 S BGPN4=1
 I BGPN2 S BGPN1=1
 I BGPN3 S BGPN1=1
 I BGPN4 S BGPN1=1
 I 'BGPN1 S BGPDVREF=$$REFDV^BGP5D5(DFN,BGP365,BGPEDATE) I $P(BGPDVREF,U)=1 S BGPN5=1
 I BGPN5 S BGPN1=1
 S BGPVALUE="AC|||"
 I $P(BGPDVEX,U)=1 S BGPVALUE=BGPVALUE_$P(BGPDVEX,U,3)_" "_$$DATE^BGP5UTL($P(BGPDVEX,U,2))
 I $P(BGPDVDX,U)=1 S BGPVALUE=BGPVALUE_$P(BGPDVDX,U,3)_" "_$$DATE^BGP5UTL($P(BGPDVDX,U,2))
 I $P(BGPDVPED,U)=1 S BGPVALUE=BGPVALUE_$P(BGPDVPED,U,3)_" "_$$DATE^BGP5UTL($P(BGPDVPED,U,2))
 I $P(BGPDVREF,U)=1 S BGPVALUE=BGPVALUE_$P(BGPDVREF,U,3)_" "_$$DATE^BGP5UTL($P(BGPDVREF,U,2))
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,T,BGPDVEX,BGPDVDX,BGPDVPED,BGPDVREF
 Q
I15 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPN3=0 S BGPDEP=$$DEP^BGP5D21(DFN,BGP365,BGPEDATE) I $P(BGPDEP,U)=1 S BGPN3=1
 S BGPN2=0 S BGPDEPS=$$DEPSCR^BGP5D21(DFN,BGP365,BGPEDATE) I $P(BGPDEPS,U)=1 S BGPN2=1
 I BGPN2 S BGPN1=1
 I BGPN3 S BGPN1=1
 S BGPVALUE=""
 S BGPVALUE="AC"
 S BGPVALUE=BGPVALUE_"|||"
 I BGPDEP]"" S BGPVALUE=BGPVALUE_$P(BGPDEP,U,2)_":"_$P(BGPDEP,U,3)
 I BGPDEPS]"" S BGPVALUE=BGPVALUE_$P(BGPDEPS,U,2)_":"_$P(BGPDEPS,U,3)
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,T,BGPDVEX,BGPDVDX,BGPDVPED,BGPDVREF
 Q
I16 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I BGPAGEB>74 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPBMI=$$BMI^BGP5D6(DFN,BGPEDATE,BGPAGEE),BGPN1=$S(BGPBMI]"":1,1:0)
 S BGPN2=$$OW^BGP5D6(DFN,BGPBMI,BGPAGEE)
 S BGPN3=$$OB^BGP5D6(DFN,BGPBMI,BGPAGEE)
 I BGPN2!(BGPN3) S BGPN4=1
 S BGPVALUE="AC"
 S BGPVALUE=BGPVALUE_"|||"_$S(BGPBMI]"":$$SB^BGP5PDL1($J($P(BGPBMI,U),6,2)),1:"")_" "_$S(BGPN2:"OW",1:"")_" "_$S(BGPN3:"OB",1:"")
 K X,Y,Z,%,A,B,C,D,E,F,G,H,BDATE,EDATE,P,V,S,F,T,BGPBMI
 Q
I17 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5,BGPN6,BGPN7)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPVALUE=$$MEANBP^BGP5D41(DFN,$$FMADD^XLFDT(BGPEDATE,-(2*365)),BGPEDATE)
 S BGPN1=$S($P(BGPVALUE,U,2):1,1:0)  ;any value 2-6
 S BGPN2=$S($P(BGPVALUE,U,2)=2:1,1:0)
 S BGPN3=$S($P(BGPVALUE,U,2)=3:1,1:0)
 S BGPN4=$S($P(BGPVALUE,U,2)=4:1,1:0)
 S BGPN5=$S($P(BGPVALUE,U,2)=5:1,1:0)
 S BGPN6=$S($P(BGPVALUE,U,2)=6:1,1:0)
 S S=$P($P(BGPVALUE,U),"/") I S>159 S BGPN7=1
 S BGPVALUE="AC"_"|||"_$P(BGPVALUE,U)
 K X,Y,Z
 Q
I18 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5,BGPN6,BGPN7)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPVALUE=$$CHOL^BGP5D73(DFN,$$FMADD^XLFDT(BGPEDATE,-(5*365)),BGPEDATE)
 I $P(BGPVALUE,U,1)]"" S BGPN1=1
 S R=$P(BGPVALUE,U,3),R=+R I R>239 S BGPN2=1
 S BGPLDL=$$LDL^BGP5D2(DFN,$$FMADD^XLFDT(BGPEDATE,-(5*365)),BGPEDATE) ;date^value
 I $P(BGPLDL,U)=1 S BGPN3=1
 I $P(BGPLDL,U,3)]"" D
 .S V=$P(BGPLDL,U,3)
 .I V]"",+V'>100 S BGPN4=1
 .I +V>100,+V<131 S BGPN5=1
 .I +V>130,+V<161 S BGPN6=1
 .I +V>160 S BGPN7=1
 S V="AC"_"|||"
 I BGPVALUE]"" S V=V_"CHOL "_$$DATE^BGP5UTL($P(BGPVALUE,U,1))_" "_$P(BGPVALUE,U,3)
 I $P(BGPLDL,U) S V=V_";LDL "_$$DATE^BGP5UTL($P(BGPLDL,U,2))_" "_$P(BGPLDL,U,3)
 S BGPVALUE=V
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,T,BGPLDL
 Q
I19 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5,BGPN6,BGPN7)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 I $P(^DPT(DFN,0),U,2)'="F" S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPFRAC=$$FRACTURE(DFN,$$FMADD^XLFDT(BGPBDATE,-180),$$FMADD^XLFDT(BGPBDATE,180))
 I '$P(BGPFRAC,U) S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPISD=$P(BGPFRAC,U,2),BGPISV=$P(BGPFRAC,U,3),BGPISV=$P(BGPFRAC,U,4)
 S BGPBMD=""
 I $P(BGPFRAC,U,3)="H" S BGPBMD=$$TXBMD^BGP5EL4(DFN,$P($P(^AUPNVSIT(BGPISV,0),U),"."),$$DSCHDATE^APCLV(BGPISV,"I"),1)
 I $P(BGPFRAC,U,3)'="H" S BGPBMD=$$TXBMD^BGP5EL4(DFN,BGPISD,$$FMADD^XLFDT(BGPISD,60))
 I $P(BGPBMD,U) S BGPN1=1
 S BGPVALUE="AC "
 S Y=""
 F X=5,6,7 S V=$P(BGPFRAC,U,X) I V]"" S:Y]"" Y=Y_";" S Y=Y_V
 S BGPVALUE=BGPVALUE_"Fracture: "_Y_" on "_$$DATE^BGP5UTL($P(BGPFRAC,U,2))_"|||"_$P(BGPBMD,U,2)
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,T,FBD,FED
 Q
I20 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5,BGPN6,BGPN7)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPVALUE=$$FUNCTION^BGP5EL4(DFN,BGPBDATE,BGPEDATE)
 I $P(BGPVALUE,U) S BGPN1=1
 S BGPVALUE="AC|||"_$P(BGPVALUE,U,2)
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,T,BGPG
 Q
I21 ;EP
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5,BGPN6,BGPN7)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 I 'BGPACTCL S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPHOSPL=""
 S BGPN1=$$V2ASTH^BGP5D31(DFN,BGP365,BGPEDATE)
 I BGPN1 S BGPHOSPL=$$HOSP^BGP5D31(DFN,BGP365,BGPEDATE) I BGPHOSPL S BGPN2=1
 S BGPVALUE="AC"_"|||"_$S(BGPN1:$$LAST^BGP5D31(DFN,BGP365,BGPEDATE),1:"")_" "_$S(BGPHOSPL:"H "_$$DATE^BGP5UTL($P(BGPHOSPL,U,2)),1:"")
 K X,Y,Z,%,A,B,C,D,E,H,BDATE,EDATE,P,V,S,F,T,BGPG
 Q
I22 ;EP - PHN
 S (BGPD1,BGPD2,BGPD3,BGPD4,BGPD5)=0
 S (BGPN1,BGPN2,BGPN3,BGPN4,BGPN5,BGPN6,BGPN7)=0
 I BGPAGEB<55 S BGPSTOP=1 Q
 S BGPD1=1
 I BGPAGEB>54,BGPAGEB<65 S BGPD2=1
 I BGPAGEB>64,BGPAGEB<75 S BGPD3=1
 I BGPAGEB>74,BGPAGEB<85 S BGPD4=1
 I BGPAGEB>84 S BGPD5=1
 S BGPVALUE=$$PHNV^BGP5EL4(DFN,BGP365,BGPEDATE,BGPHOME)
 S BGPN1=BGPVALUE
 S BGPVALUE="UP|||"_$P(BGPVALUE,U)_" all PHN; "_$P(BGPVALUE,U,7)_" home; "_$P(BGPVALUE,U,6)_" driver all; "_$P(BGPVALUE,U,12)_" driver home"
 Q
FRACTURE(P,BDATE,EDATE) ;EP
 ;loop through povs, procedures, cpts to find all indications of a fracture
 ;table them by date so earliest is on top, set what is found as text
 ;the earliest found becomes the index start date
 S (X,I,Y,T)=0
 ;S T=$O(^ATXAX("B","BGP FRACTURE DXS",0))
 K BGPG,BGPV S BGPGO=""
 S Y="BGPG("
 S X=P_"^FIRST DX [BGP FRACTURE DXS;DURING "_$$FMTE^XLFDT(BDATE)_"-"_$$FMTE^XLFDT(EDATE) S E=$$START1^APCLDF(X,Y)
 I $D(BGPG(1)) D
 .S BGPV($P(BGPG(1),U),$P(BGPG(1),U,5))="DX: "_$P(BGPG(1),U,2)
 .S BGPGO=1
 ;now check all cpts for fracture
 K BGPG ;gather up all cpts that are fractures by date
 S T=$O(^ATXAX("B","BGP FRACTURE CPTS",0))
 S X=0 F  S X=$O(^AUPNVCPT("AC",P,X)) Q:X'=+X  D
 .S I=$P($G(^AUPNVCPT(X,0)),U) Q:I=""
 .S C=$P($$CPT^ICPTCOD(I),U,2) Q:C=""
 .Q:'$$ICD^ATXCHK(I,T,1)
 .S V=$P(^AUPNVCPT(X,0),U,3)
 .S D=$P($P($G(^AUPNVSIT(V,0)),U),".")
 .Q:D<BDATE
 .Q:D>EDATE
 .I '$D(BGPV(D,V)) S BGPV(D,V)=""
 .S $P(BGPV(D,V),U,2)="CPT: "_C
 ;now get first procedure
 K BGPG S Y="BGPG("
 S BGPG=$$FIRSTPRC^BGP5UTL1(P,"BGP FRACTURE PROCEDURES",BDATE,EDATE)
 I $P(BGPG,U)=1 D
 .S D=$P(BGPG,U,3)
 .S V=$P(BGPG,U,5),V=$P($G(^AUPNVPRC(V,0)),U,3)
 .Q:'V
 .I '$D(BGPV(D,V)) S BGPV(D,V)=""
 .S $P(BGPV(D,V),U,3)="PROC: "_$P(BGPG,U,2)
 S BGPISD=$O(BGPV(0))
 I BGPISD="" Q ""  ;no fractures
 S BGPISV=$O(BGPV(BGPISD,0))
 S BGPIST=$P(^AUPNVSIT(BGPISV,0),U,7) I BGPIST="H" S X=$$DSCHDATE^APCLV(BGPISV,"I") D
 .Q:X=""
 .Q:X=BGPISD  ;dsch same as adm
 .S BGPV(X,BGPISV)=BGPV(BGPISD,BGPISV)
 .K BGPV(BGPISD,BGPISV)
 .S BGPISD=X
 I BGPISD="" Q ""  ;no discharge date
 ;now to exclusions
 ;first check for any tx or bmd in 365 days prior to index start date
 S BGPX=$$TXBMD^BGP5EL4(P,$$FMADD^XLFDT(BGPISD,-365),$$FMADD^XLFDT(BGPISD,-1)) I $P(BGPX,U) S $P(BGPV(BGPISD,BGPISV),U,5)=$P(BGPX,U,2) Q ""
 ;if outpatient exclude if any fracture in 60 days prior to index start date
 I BGPIST'="H",$$FRACT(P,$$FMADD^XLFDT(BGPISD,-60),$$FMADD^XLFDT(BGPISD,-1)) S $P(BGPV(BGPISD,BGPISV),U,5)="excl: prior fx" Q ""
 I BGPIST="H" S D=$P($P(^AUPNVSIT(BGPISV,0),U),".") I $$FRACT(P,$$FMADD^XLFDT(D,-60),$$FMADD^XLFDT(D,-1)) S $P(BGPV(BGPISD,BGPISV),U,5)="excl: prior fx" Q ""
 Q 1_U_BGPISD_U_BGPISV_U_BGPIST_U_BGPV(BGPISD,BGPISV)
 ;
FRACT(P,FBD,FED) ;
 S (X,I,Y,T)=0
 ;S T=$O(^ATXAX("B","BGP FRACTURE DXS",0))
 K BGPG S BGPGO=""
 S Y="BGPG("
 S X=P_"^FIRST DX [BGP FRACTURE DXS;DURING "_$$FMTE^XLFDT(FBD)_"-"_$$FMTE^XLFDT(FED) S E=$$START1^APCLDF(X,Y)
 I $D(BGPG(1)) Q 1
 ;now check all cpts for fracture
 K BGPG ;gather up all cpts that are fractures by date
 S BGPG=0
 S T=$O(^ATXAX("B","BGP FRACTURE CPTS",0))
 S X=0 F  S X=$O(^AUPNVCPT("AC",P,X)) Q:X'=+X!(BGPG)  D
 .S I=$P($G(^AUPNVCPT(X,0)),U) Q:I=""
 .S C=$P($$CPT^ICPTCOD(I),U,2) Q:C=""
 .Q:'$$ICD^ATXCHK(I,T,1)
 .S V=$P(^AUPNVCPT(X,0),U,3)
 .S D=$P($P($G(^AUPNVSIT(V,0)),U),".")
 .Q:D<FBD
 .Q:D>FED
 .S BGPG=1
 I BGPG Q 1
 ;now get first procedure
 S BGPG=$$FIRSTPRC^BGP5UTL1(P,"BGP FRACTURE PROCEDURES",FBD,FED)
 I $P(BGPG,U)=1 Q 1
 Q ""
