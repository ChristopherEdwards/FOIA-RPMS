BGPMUDP5 ; IHS/MSC/SAT - MU EP measures NQF0033 ;29-AUG-2011 11:26;DU
 ;;11.1;IHS CLINICAL REPORTING SYSTEM;**1**;JUN 27, 2011;Build 106
 ;Printed output reports for this measure
PCHL ;EP
 D P1
 K ^TMP("BGPMU0033")
 Q
P1 ;Write individual measure
 N X,Y,Z,LIST1,LIST2,LIST3
 N DEN1,NUM1,DEN2,NUM2,PC1,PC2,EXC1,EXC2,STRING1,STRING2,STRING3,SUMCT
 N PRD1,PRD2,PRD3,PRD4,PRN1,PRN2,PRN3,PRN4,PRN5,PRN6,PRD5,PRD6
 S SUMCT=0
 S STRING1=$$NUM33("C")
 S STRING2=$$NUM33("P")
 S STRING3=$$NUM33("B")
 D SUMMARY1(STRING1,STRING2,STRING3)
 ;Population
 S PRD11=$P(STRING1,U,5)-$P(STRING2,U,5)
 S PRD14=$P(STRING1,U,9)-$P(STRING2,U,9)
 S PRN11=$P(STRING1,U,5)-$P(STRING3,U,5)
 S PRN14=$P(STRING1,U,9)-$P(STRING3,U,9)
 S PRD21=$P(STRING1,U,14)-$P(STRING2,U,14)
 S PRD24=$P(STRING1,U,18)-$P(STRING2,U,18)
 S PRN21=$P(STRING1,U,14)-$P(STRING3,U,14)
 S PRN24=$P(STRING1,U,18)-$P(STRING3,U,18)
 S PRD31=$P(STRING1,U,23)-$P(STRING2,U,23)
 S PRD34=$P(STRING1,U,27)-$P(STRING2,U,27)
 S PRN31=$P(STRING1,U,23)-$P(STRING3,U,23)
 S PRN34=$P(STRING1,U,27)-$P(STRING3,U,27)
 D HEADER^BGPMUPH Q:BGPQUIT
 D HDRBLK^BGPMUPH
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 ;
 W !,"Denominator 1"
 W !!,"Pts 15-24 sexually active",?33,$P(STRING1,U,1),?44,$P(STRING2,U,1),?64,$P(STRING3,U,1)
 W !,"females"
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"# Excluded (Exc)",?33,+$P(STRING1,U,4),?44,+$P(STRING2,U,4),?64,+$P(STRING3,U,4)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"Pts 15-24 sexually active",?33,$P(STRING1,U,3),?44,$P(STRING2,U,3),?64,$P(STRING3,U,3)
 W !,"females less Exc"
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !!,"# w/chlamydia screening",?33,+$P(STRING1,U,2),?38,$J($P(STRING1,U,5),5,1),?44,+$P(STRING2,U,2),?49,$J($P(STRING2,U,5),5,1),?56,$J($FN(PRD11,",+",1),6),?64,+$P(STRING3,U,2),?68,$J($P(STRING3,U,5),5,1),?74,$J($FN(PRN11,",+",1),6)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"# w/o chlamydia screening",?33,+$P(STRING1,U,8),?38,$J($P(STRING1,U,9),5,1),?44,+$P(STRING2,U,8),?49,$J($P(STRING2,U,9),5,1),?56,$J($FN(PRD14,",+",1),6),?64,+$P(STRING3,U,8),?68,$J($P(STRING3,U,9),5,1),?74,$J($FN(PRN14,",+",1),6)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 ;
 W !!,"Denominator 2"
 W !!,"Pts 15-19 sexually active",?33,+$P(STRING1,U,10),?44,+$P(STRING2,U,10),?64,+$P(STRING3,U,10)
 W !,"females"
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"# Excluded (Exc)",?33,+$P(STRING1,U,13),?44,+$P(STRING2,U,13),?64,+$P(STRING3,U,13)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"Pts 15-19 sexually active",?33,+$P(STRING1,U,12),?44,+$P(STRING2,U,12),?64,+$P(STRING3,U,12)
 W !,"females less Exc"
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !!,"# w/chlamydia screening",?33,+$P(STRING1,U,11),?38,$J($P(STRING1,U,14),5,1),?44,+$P(STRING2,U,11),?49,$J($P(STRING2,U,14),5,1),?56,$J($FN(PRD21,",+",1),6),?64,+$P(STRING3,U,11),?68,$J($P(STRING3,U,14),5,1),?74,$J($FN(PRN21,",+",1),6)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"# w/o chlamydia screening",?33,+$P(STRING1,U,17),?38,$J($P(STRING1,U,18),5,1),?44,+$P(STRING2,U,17),?49,$J($P(STRING2,U,18),5,1),?56,$J($FN(PRD24,",+",1),6),?64,+$P(STRING3,U,17),?68,$J($P(STRING3,U,18),5,1),?74,$J($FN(PRN24,",+",1),6)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 ;
 W !!,"Denominator 3"
 W !!,"Pts 20-24 sexually active",?33,+$P(STRING1,U,19),?44,+$P(STRING2,U,19),?64,+$P(STRING3,U,19)
 W !,"females"
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"# Excluded (Exc)",?33,+$P(STRING1,U,22),?44,+$P(STRING2,U,22),?64,+$P(STRING3,U,22)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"Pts 20-24 sexually active",?33,+$P(STRING1,U,21),?44,+$P(STRING2,U,21),?64,+$P(STRING3,U,21)
 W !,"females less Exc"
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !!,"# w/chlamydia screening",?33,+$P(STRING1,U,20),?38,$J($P(STRING1,U,23),5,1),?44,+$P(STRING2,U,20),?49,$J($P(STRING2,U,23),5,1),?56,$J($FN(PRD31,",+",1),6),?64,+$P(STRING3,U,20),?68,$J($P(STRING3,U,23),5,1),?74,$J($FN(PRN31,",+",1),6)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 W !,"# w/o chlamydia screening",?33,+$P(STRING1,U,26),?38,$J($P(STRING1,U,27),5,1),?44,+$P(STRING2,U,26),?49,$J($P(STRING2,U,27),5,1),?56,$J($FN(PRD34,",+",1),6),?64,+$P(STRING3,U,26),?68,$J($P(STRING3,U,27),5,1),?74,$J($FN(PRN34,",+",1),6)
 I $Y>(BGPIOSL-3) D HEADER^BGPMUPH,HDRBLK^BGPMUPH Q:BGPQUIT
 ;
 I $D(BGPLIST(BGPIC)) D P2
 ;
 Q
 ;
NUM33(TF) ;Get the numbers for this measure
 N ARRAY,DEN,NUM,EXC,NOT,PC1,PC11,PC2,PC14,PC21,PC13,NNUM
 S DEN1=+$G(^TMP("BGPMU0033",$J,TF,"DEN",1))
 S DEN2=+$G(^TMP("BGPMU0033",$J,TF,"DEN",2))
 S DEN3=+$G(^TMP("BGPMU0033",$J,TF,"DEN",3))
 S NUM1=+$G(^TMP("BGPMU0033",$J,TF,"NUM",1))
 S NUM2=+$G(^TMP("BGPMU0033",$J,TF,"NUM",2))
 S NUM3=+$G(^TMP("BGPMU0033",$J,TF,"NUM",3))
 S NOT1=+$G(^TMP("BGPMU0033",$J,TF,"NOT",1))
 S NOT2=+$G(^TMP("BGPMU0033",$J,TF,"NOT",2))
 S NOT3=+$G(^TMP("BGPMU0033",$J,TF,"NOT",3))
 S EXC1=+$G(^TMP("BGPMU0033",$J,TF,"EXC",1))
 S EXC2=+$G(^TMP("BGPMU0033",$J,TF,"EXC",2))
 S EXC3=+$G(^TMP("BGPMU0033",$J,TF,"EXC",3))
 ;DEN1
 S NNUMD1=DEN1-EXC1
 I DEN1=0 S (PC1D1,PC11D1,PC13D1,PC14D1)=0
 I DEN1>0&(NNUMD1=0) D
 .S (PC1D1,PC11D1,PC14D1)=0
 .S PC13D1=$$ROUND^BGPMUA01((EXC1/DEN1),3)*100
 I DEN1>0&(NNUMD1>0) D
 .S PC1D1=$$ROUND^BGPMUA01((NUM1/NNUMD1),3)*100
 .S PC11D1=$$ROUND^BGPMUA01((NNUMD1/DEN1),3)*100
 .S PC13D1=$$ROUND^BGPMUA01((EXC1/DEN1),3)*100
 .S PC14D1=$$ROUND^BGPMUA01((NOT1/NNUMD1),3)*100
 ;DEN2
 S NNUMD2=DEN2-EXC2
 I DEN2=0 S (PC1D2,PC11D2,PC13D2,PC14D2)=0
 I DEN2>0&(NNUMD2=0) D
 .S (PC1D2,PC11D2,PC14D2)=0
 .S PC13D2=$$ROUND^BGPMUA01((EXC2/DEN2),3)*100
 I DEN2>0&(NNUMD2>0) D
 .S PC1D2=$$ROUND^BGPMUA01((NUM2/NNUMD2),3)*100
 .S PC11D2=$$ROUND^BGPMUA01((NNUMD2/DEN2),3)*100
 .S PC13D2=$$ROUND^BGPMUA01((EXC2/DEN2),3)*100
 .S PC14D2=$$ROUND^BGPMUA01((NOT2/NNUMD2),3)*100
 ;DEN3
 S NNUMD3=DEN3-EXC3
 I DEN3=0 S (PC1D3,PC11D3,PC13D3,PC14D3)=0
 I DEN3>0&(NNUMD3=0) D
 .S (PC1D3,PC11D3,PC14D3)=0
 .S PC13D3=$$ROUND^BGPMUA01((EXC3/DEN3),3)*100
 I DEN3>0&(NNUMD3>0) D
 .S PC1D3=$$ROUND^BGPMUA01((NUM3/NNUMD3),3)*100
 .S PC11D3=$$ROUND^BGPMUA01((NNUMD3/DEN3),3)*100
 .S PC13D3=$$ROUND^BGPMUA01((EXC3/DEN3),3)*100
 .S PC14D3=$$ROUND^BGPMUA01((NOT3/NNUMD3),3)*100
 ;         1        2         3         4        5         6        7        8       9       10  11    12     13
 S ARRAY=(+DEN1)_U_+NUM1_U_(+NNUMD1)_U_+EXC1_U_(+PC1D1)_U_PC11D1_U_PC13D1_U_+NOT1_U_+PC14D1
 ;                 10       11       12         13       14       15       16        17      18
 S ARRAY=ARRAY_U_(+DEN2)_U_+NUM2_U_(+NNUMD2)_U_+EXC2_U_(+PC1D2)_U_PC11D2_U_PC13D2_U_+NOT2_U_+PC14D2
 ;                 19       20       21         22       23       24       25        26      27
 S ARRAY=ARRAY_U_(+DEN3)_U_+NUM3_U_(+NNUMD3)_U_+EXC3_U_(+PC1D3)_U_PC11D3_U_PC13D3_U_+NOT3_U_+PC14D3
 Q ARRAY
 ;
P2 ;Do the Details
 N PT,NODE,NAME,VST,BMI,FOL,X,PTCT,BGPARR,LINE
 D HEADERL^BGPMUPH
 S X="Patients 15-24 years of age with at least 1 encounter with the EP within 1 year" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="of the reporting period end date, who have been identified as sexually active or" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="pregnant on or before the reporting period end date AND who had at least" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="1 chlamydia screening during the reporting period, if any." D W^BGPMUPP(X,0,1,BGPPTYPE)
 ;
 S X="Patients who do not meet the numerator criteria are listed first (NM:), followed" D W^BGPMUPP(X,0,2,BGPPTYPE)
 S X="by patients who do meet the numerator criteria (M:).  Excluded patients are" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="listed last." D W^BGPMUPP(X,0,1,BGPPTYPE)
 ;
 S X="The following are the abbreviations used in the denominator and numerator" D W^BGPMUPP(X,0,2,BGPPTYPE)
 S X="columns:" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="PROC=Procedure Indicative of a Sexually Active Woman" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="LABP=Laboratory Test for Pregnancy" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="PREG=Pregnancy Encounter" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="LAB=Laboratory Test Indicative of a Sexually Active Woman" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="DX=Diagnosis Indicative of a Sexually Active Woman" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="MED=Contraceptive Medication" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="IUD=Use of IUD Device" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="ALR=Allergy to IUD Device" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="EDU=Contraceptive Use Education" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="RF=Reproductive Factor" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="EN=Encounter" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="CHL=Chlamydia screening" D W^BGPMUPP(X,0,1,BGPPTYPE)
 S X="" D W^BGPMUPP(X,0,1,BGPPTYPE)
 ;
 S PTCT=0
 I $Y>(BGPIOSL-5) D HEADERL^BGPMUPH Q:BGPQUIT
 S X="Patients 15-19" D W^BGPMUPP(X,0,1,BGPPTYPE)
 W !!,"PATIENT NAME",?23,"HRN",?30,"COMMUNITY",?42,"SEX",?46,"AGE",?50,"DENOMINATOR",?65,"NUMERATOR"
 S LINE="",$P(LINE,"-",81)="" W !,LINE
 I BGPLIST="D"!(BGPLIST="A") D
 .K BGPARR
 .D PTLSORT^BGPMUUTL(.BGPARR,"^TMP(""BGPMU0033"","_$J_",""PAT"",""C"",""NOT"",2)")
 .S PT=0 F  S PT=$O(BGPARR(PT)) Q:PT=""  D
 ..S PTCT=PTCT+1
 ..S NODE=$G(BGPARR(PT))
 ..D DATA(NODE)
 I BGPLIST="N"!(BGPLIST="A") D
 .K BGPARR
 .D PTLSORT^BGPMUUTL(.BGPARR,"^TMP(""BGPMU0033"","_$J_",""PAT"",""C"",""NUM"",2)")
 .S PT=0 F  S PT=$O(BGPARR(PT)) Q:PT=""  D
 ..S PTCT=PTCT+1
 ..S NODE=$G(BGPARR(PT))
 ..D DATA(NODE)
 I BGPLIST="A" D
 .K BGPARR
 .D PTLSORT^BGPMUUTL(.BGPARR,"^TMP(""BGPMU0033"","_$J_",""PAT"",""C"",""EXC"",2)")
 .S PT=0 F  S PT=$O(BGPARR(PT)) Q:PT=""  D
 ..S PTCT=PTCT+1
 ..S NODE=$G(BGPARR(PT))
 ..D DATA(NODE)
 W !!,"Total # of patients on list: "_PTCT
 S X="" D W^BGPMUPP(X,0,1,BGPPTYPE)
 ;
 S PTCT=0
 I $Y>(BGPIOSL-5) D HEADERL^BGPMUPH Q:BGPQUIT
 S X="Patients 20-24" D W^BGPMUPP(X,0,1,BGPPTYPE)
 W !!,"PATIENT NAME",?23,"HRN",?30,"COMMUNITY",?42,"SEX",?46,"AGE",?50,"DENOMINATOR",?65,"NUMERATOR"
 S LINE="",$P(LINE,"-",81)="" W !,LINE
 I BGPLIST="D"!(BGPLIST="A") D
 .K BGPARR
 .D PTLSORT^BGPMUUTL(.BGPARR,"^TMP(""BGPMU0033"","_$J_",""PAT"",""C"",""NOT"",3)")
 .S PT=0 F  S PT=$O(BGPARR(PT)) Q:PT=""  D
 ..S PTCT=PTCT+1
 ..S NODE=$G(BGPARR(PT))
 ..D DATA(NODE)
 I BGPLIST="N"!(BGPLIST="A") D
 .K BGPARR
 .D PTLSORT^BGPMUUTL(.BGPARR,"^TMP(""BGPMU0033"","_$J_",""PAT"",""C"",""NUM"",3)")
 .S PT=0 F  S PT=$O(BGPARR(PT)) Q:PT=""  D
 ..S PTCT=PTCT+1
 ..S NODE=$G(BGPARR(PT))
 ..D DATA(NODE)
 I BGPLIST="A" D
 .K BGPARR
 .D PTLSORT^BGPMUUTL(.BGPARR,"^TMP(""BGPMU0033"","_$J_",""PAT"",""C"",""EXC"",3)")
 .S PT=0 F  S PT=$O(BGPARR(PT)) Q:PT=""  D
 ..S PTCT=PTCT+1
 ..S NODE=$G(BGPARR(PT))
 ..D DATA(NODE)
 W !!,"Total # of patients on list: "_PTCT
 Q
DATA(NODE) ;GET DATA
 N NAME,HRN,DEN,NUM,AGE,DFN,SEX,COMM,NUM1,NUM2,DEN1,DEN2,DEN3,LINE
 S DFN=$P(NODE,U,1)
 S NAME=$E($$GET1^DIQ(2,$P(NODE,U,1),.01),1,22)
 S HRN=$$HRN^AUPNPAT(DFN,DUZ(2))
 S AGE=$$AGE^AUPNPAT(DFN,BGPED)
 S DEN=$P(NODE,U,2)
 S NUM=$P(NODE,U,3)
 S COMM=$E($$GET1^DIQ(9000001,DFN,1118),1,11)
 S SEX=$P(^DPT(DFN,0),U,2)
 I $Y>(BGPIOSL-2) D
 .D HEADERL^BGPMUPH Q:BGPQUIT
 .W !,"PATIENT NAME",?23,"HRN",?30,"COMMUNITY",?42,"SEX",?46,"AGE",?50,"DENOMINATOR",?65,"NUMERATOR"
 .S LINE="",$P(LINE,"-",81)="" W !,LINE
 W !,NAME,?23,HRN,?30,COMM,?43,SEX,?46,AGE,?50,$P(DEN,";",1),?65,NUM
 F BGPI=2:1:$L(DEN,";") D
 .W !,?50,$P(DEN,";",BGPI)
 Q
SUMMARY1(STRING1,STRING2,STRING3,CT) ;Summmary setup
 N DESC,DESC2,LINE
 K ^TMP("BGPMU SUMMARY",$J,BGPIC)
 S ^TMP("BGPMU SUMMARY",$J,BGPIC)="0033^N/A"
 S DESC1="15-24 # w/chlamydia screening"
 S DESC2="15-19 # w/chlamydia screening"
 S DESC3="20-24 # w/chlamydia screening"
 S LINE=""
 ;
 S LINE="MU.EP.0033.1"_U_DESC1_U_+$P(STRING1,U,4)_U_+$P(STRING1,U,1)_U_+$P(STRING1,U,2)_U_+$P(STRING1,U,5)_U_U_U_U_U
 S LINE=LINE_+$P(STRING2,U,4)_U_+$P(STRING2,U,1)_U_+$P(STRING2,U,2)_U_+$P(STRING2,U,5)_U_+$P(STRING3,U,4)_U_+$P(STRING3,U,1)_U_+$P(STRING3,U,2)_U_+$P(STRING3,U,5)
 S ^TMP("BGPMU SUMMARY",$J,BGPIC,1)=LINE
 ;
 S LINE="MU.EP.0033.1"_U_DESC2_U_+$P(STRING1,U,13)_U_+$P(STRING1,U,10)_U_+$P(STRING1,U,11)_U_+$P(STRING1,U,14)_U_U_U_U_U
 S LINE=LINE_+$P(STRING2,U,13)_U_+$P(STRING2,U,10)_U_+$P(STRING2,U,11)_U_+$P(STRING2,U,14)_U_+$P(STRING3,U,13)_U_+$P(STRING3,U,10)_U_+$P(STRING3,U,11)_U_+$P(STRING3,U,14)
 S ^TMP("BGPMU SUMMARY",$J,BGPIC,2)=LINE
 ;
 S LINE="MU.EP.0033.1"_U_DESC3_U_+$P(STRING1,U,22)_U_+$P(STRING1,U,19)_U_+$P(STRING1,U,20)_U_+$P(STRING1,U,23)_U_U_U_U_U
 S LINE=LINE_+$P(STRING2,U,22)_U_+$P(STRING2,U,19)_U_+$P(STRING2,U,20)_U_+$P(STRING2,U,23)_U_+$P(STRING3,U,22)_U_+$P(STRING3,U,19)_U_+$P(STRING3,U,20)_U_+$P(STRING3,U,23)
 S ^TMP("BGPMU SUMMARY",$J,BGPIC,3)=LINE
 Q
XML33 ;Populate the BGPXML array with data for each population/numerator
 ; BGPXMLOUT(i)=PQRI number^""^Denominator Count^Numerator Count^Exclusion Count
 S BGPXML(1)="N/A"_U_""_U_+$G(^TMP("BGPMU0033",$J,"C","DEN",1))_U_+$G(^TMP("BGPMU0033",$J,"C","NUM",1))_U_+$G(^TMP("BGPMU0033",$J,"C","EXC",1))
 S BGPXML(2)="N/A"_U_""_U_+$G(^TMP("BGPMU0033",$J,"C","DEN",2))_U_+$G(^TMP("BGPMU0033",$J,"C","NUM",2))_U_+$G(^TMP("BGPMU0033",$J,"C","EXC",2))
 S BGPXML(3)="N/A"_U_""_U_+$G(^TMP("BGPMU0033",$J,"C","DEN",3))_U_+$G(^TMP("BGPMU0033",$J,"C","NUM",3))_U_+$G(^TMP("BGPMU0033",$J,"C","EXC",3))
 K ^TMP("BGPMU0033",$J)
 Q
TEST ;
 S U="^"
 D PCHL
 S BGPIC="A"
 S BGPLIST(BGPIC)=1
 Q
