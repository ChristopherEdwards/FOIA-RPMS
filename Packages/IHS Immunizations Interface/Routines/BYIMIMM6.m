BYIMIMM6 ;IHS/CIM/THL - IMMUNIZATION DATA INTERCHANGE;
 ;;2.0;BYIM IMMUNIZATION DATA EXCHANGE INTERFACE;**3,4**;NOV 01, 2013;Build 189
 ;
MENU ;EP;HEADER DISPLAY
 W @IOF
 N PAC,PAH,VER,EXP,IMP
 D M1
 D M2
 Q
 ;-----
M1 ;MENU DISPLAY
 D PATH^BYIMIMM
 S (PAC,PAH,VER)=""
 S PAC=+$O(^DIC(9.4,"C","BYIM",0))
 S VER=$P($G(^DIC(9.4,PAC,"VERSION")),U)
 S:VER PAH=$O(^DIC(9.4,PAC,22,"B",VER,0))
 S:PAH PAH=$O(^DIC(9.4,PAC,22,PAH,"PAH","B",99999),-1)
 S:PAH]"" VER=VER_" P "_PAH
 S VER="BYIM: "_VER
 S HL7="HL7 : "_BYIMVER
 S LOC=$P($G(^DIC(4,DUZ(2),0)),U)
 N X
 S X="Immunization Data Exchange"
 S EXP=$O(^DIC(19,"B","BYIM IZ AUTO EXPORT",0))
 S EXP=$O(^DIC(19.2,"B",+EXP,0))
 S EXP=$P($G(^DIC(19.2,+EXP,0)),U,2)
 I EXP S Y=EXP D DD^%DT S EXP=$P(Y,",")_"@"_$P(Y,"@",2)
 S EXP="NEXT EXP: "_$S(EXP="":"NOT SCHED",1:EXP)
 S IMP=$O(^DIC(19,"B","BYIM IZ AUTO IMPORT",0))
 S IMP=$O(^DIC(19.2,"B",+IMP,0))
 S IMP=$P($G(^DIC(19.2,+IMP,0)),U,2)
 I IMP S Y=IMP D DD^%DT S IMP=$P(Y,",")_"@"_$P(Y,"@",2)
 S IMP="NEXT IMP: "_$S(IMP="":"NOT SCHED",1:IMP)
 Q
 ;-----
ADDLOT(DFN,IVDA,LOTDA,VDATE) ;EP;TO ADD LOT NUMBER
 ;DFN     - PATIENT DFN
 ;IVDA    - IMMUNIZATION FILE IEN
 ;LOTDA   - LOT NUMBER FILE IEN
 ;VDATE   - VISIT DATE
 H 1
 N X,Y,Z
 S X=$O(^AUPNVIMM("AC",DFN,9999999999),-1)
 Q:'X
 Q:+$G(^AUPNVIMM(X,0))'=IVDA
 Q:$P($G(^AUPNVIMM(X,0)),U,5)
 S Y=+$P($G(^AUPNVIMM(X,0)),U,3)
 Q:$P($G(^AUPNVSIT(Y,0)),".")'=$P(VDATE,".")
 N DIE,DIC,DINUM,DR,DA,DD,DO,DIK,DLAYGO
 S DA=X
 S DR=".05////"_LOTDA
 S DIE="^AUPNVIMM("
 D ^DIE
 K DIE,DIC,DINUM,DR,DA,DD,DO,DIK,DLAYGO
 Q
 ;-----
M2 ;VERSION 2.0 HEADER
 N X
 S X="Immunization Data Exchange"
 W !?80-$L(X)\2,X
 W !?80-$L(LOC)\2,LOC
 W !!?20,VER,?40,EXP
 W !?20,HL7,?40,IMP
 Q
 ;-----
SCRN(INDA) ;EP;TO SCREEN IMM'S TO INCLUDE IN EXPORT
 I $G(INDA("BYIMALL"))=2 Q 1
 I '$G(BYIMDATE) S BYIMDATE=$O(^BYIMPARA(DUZ(2),"LAST EXPORT",9999999999),-1)
 I $G(BYIMDATE),$P($G(^AUPNVIMM(INDA,12)),U,18)=BYIMDATE Q 1
 I '$D(^BYIMEXP("D",INDA)),$P($G(^AUPNVIMM(INDA,0)),U,15)!($P($G(^AUTTIMM(+$G(^AUPNVIMM(+$G(INDA),0)),0)),U,3)=999) S ^BYIMEXP("D",INDA)="" Q 0
 I '$D(^BYIMEXP("D",INDA)),'$P($G(^AUPNVIMM(INDA,0)),U,15),$P($G(^AUTTIMM(+$G(^AUPNVIMM(+$G(INDA),0)),0)),U,3)'=999 Q 1
 Q 0
 ;-----
HFSA(DEST,PRI) ;EP;TO FIND HL7 MESSAGE THAT HAVEN'T BEEN EXPORTED
 Q:PRI=""!'DEST
 K ^BYIMTMP("LE")
 K ^BYIMTMP("OF")
 N X,Y,Z,XX
 S X=""
 F  S X=$O(^INLHDEST(DEST,PRI,X)) Q:X=""  D
 .S Y=0
 .F  S Y=$O(^INLHDEST(DEST,PRI,X,Y)) Q:'Y  S ^BYIMTMP("OF",Y)="" S:$G(^INTHU(Y,3,1,0))["FHS|" XX=$P(X,",")_","_($P(X,",",2)+1)
 S X=0
 F  S X=$O(^BYIMPARA(DUZ(2),"LAST EXPORT",X)) Q:'X  I X'=DT,'$P(^(X),U,2) S ^BYIMTMP("LE",X+17000000)="",$P(^BYIMPARA(DUZ(2),"LAST EXPORT"),X,U,2)=$P(^BYIMPARA(DUZ(2),"LAST EXPORT",X),U)
 S:$G(BYIM("MSH3.1"))="" BYIM("MSH3.1")=$P($G(^BYIMPARA(DUZ(2)),1),U,3)
 S:$G(BYIM("MSH3.1"))="" BYIM("MSH3.1")="RPMS"
 S:'$G(XX) XX=$H
 S X=0
 F  S X=$O(^INTHU(X)) Q:'X  S Z=$G(^(X,3,1,0)) I Z["VXU^V04",Z["MSH|",$P($P(Z,"|",3),U)=BYIM("MSH3.1"),'$D(^BYIMTMP("OF",X)) D
 .S Y=$E($P(Z,"|",7),1,8)
 .Q:'$D(^BYIMTMP("LE",Y))
 .S ^INLHDEST(DEST,PRI,XX,X)=""
 .S ^BYIMTMP("OF",X)=""
 .S $P(^BYIMTMP("NUM"),U,2)=$P($G(^BYIMTMP("NUM")),U,2)
 .S Y=0
 .F  S Y=$O(^INTHU(X,3,Y)) Q:'Y  S:^(Y,0)["RXA|" $P(^BYIMTMP("NUM"),U,3)=$P($G(^BYIMTMP("NUM")),U,3)+1
 K ^BYIMTMP("LE")
 K ^BYIMTMP("OF")
 Q
 ;-----
