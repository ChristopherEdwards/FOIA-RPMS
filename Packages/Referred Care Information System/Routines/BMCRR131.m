BMCRR131 ; IHS/PHXAO/TMJ - PROCESS REFERRAL LIST ;  
 ;;4.0;REFERRED CARE INFO SYSTEM;;JAN 09, 2006
 ;IHS/ITSC/FCJ ADDED SORT BY BEG AND END DATE OF REF INITIATED
 ;
START ;
 S (BMCBT,BMCBTH)=$H,BMCJOB=$J,BMCRCNT=0
 D PROCESS,END
 Q
 ;
PROCESS ;
 ;S BMCREF=0 F  S BMCREF=$O(^BMCREF("AB","A",BMCREF)) Q:BMCREF'=+BMCREF  D PROC
 ;
 S BMCODAT=$O(^BMCREF("B",BMCSD)) I BMCODAT="" S BMCET=$H Q
 S BMCODAT=BMCSD_".9999" F  S BMCODAT=$O(^BMCREF("B",BMCODAT)) Q:BMCODAT=""!((BMCODAT\1)>BMCED)  D R1
 Q
 ;
R1 ;
 S BMCREF="" F  S BMCREF=$O(^BMCREF("B",BMCODAT,BMCREF)) Q:BMCREF'=+BMCREF  S BMCRREC=^BMCREF(BMCREF,0) D PROC
 Q
 ;
END ;
 S BMCET=$H
 Q
PROC ;
 S BMCRREC=^BMCREF(BMCREF,0),DFN=$P(BMCRREC,U,3)
 Q:$P(BMCRREC,U,4)="N"
 Q:$P(BMCRREC,U,15)'="A"
 ;get sort value
 I $G(BMCPROV),BMCPROV'=$P(BMCRREC,U,6) Q
 S BMCPRV=$P(BMCRREC,U,6) S:BMCPRV BMCPRV=$P($G(^VA(200,BMCPRV,0)),U) S:BMCPRV="" BMCPRV="--"
 S ^XTMP("BMCRR13",BMCJOB,BMCBTH,"DATA HITS",BMCPRV,BMCREF)="",BMCRCNT=BMCRCNT+1
 Q
