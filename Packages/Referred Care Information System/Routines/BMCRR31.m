BMCRR31 ; IHS/OHPRD/TMJ - PROCESS REFERRAL LIST ;  
 ;;4.0;REFERRED CARE INFO SYSTEM;;JAN 09, 2006
 ;IHS/ITSC/FCJ TEST FOR SR, SKIP SINCE NO COST DATA IS ENTERED
 ;
 ;
START ;
 S (BMCBT,BMCBTH)=$H,BMCJOB=$J,BMCRCNT=0
 D PROCESS,END
 Q
 ;
PROCESS ;
 ;
V ; Run by visit date
 S BMCODAT=$O(^BMCREF("B",BMCSD)) I BMCODAT="" S BMCET=$H Q
 S BMCODAT=BMCSD_".9999" F  S BMCODAT=$O(^BMCREF("B",BMCODAT)) Q:BMCODAT=""!((BMCODAT\1)>BMCED)  D PROC
 Q
 ;
END ;
 S BMCET=$H
 Q
PROC ;
 S BMCREF="" F  S BMCREF=$O(^BMCREF("B",BMCODAT,BMCREF)) Q:BMCREF'=+BMCREF  S BMCRREC=^BMCREF(BMCREF,0),DFN=$P(BMCRREC,U,3) D PROCR
 Q
 ;
PROCR ;
 Q:$P(BMCRREC,U,4)="N"
 Q:$P($G(^BMCREF(BMCREF,1)),U)'=""
 I '$D(^XTMP("BMCRR3",BMCJOB,BMCBTH,"DATA HITS",$P(^DPT(DFN,0),U),DFN)) S ^XTMP("BMCRR3",BMCJOB,BMCBTH,"DATA HITS",$P(^DPT(DFN,0),U),DFN)=""
 I BMCCOST="I" S BMCDOLL=$$AVICOST^BMCRLU(BMCREF)
 I BMCCOST="T" S BMCDOLL=$$AVTCOST^BMCRLU(BMCREF)
 S $P(^XTMP("BMCRR3",BMCJOB,BMCBTH,"DATA HITS",$P(^DPT(DFN,0),U),DFN),U)=$P(^XTMP("BMCRR3",BMCJOB,BMCBTH,"DATA HITS",$P(^DPT(DFN,0),U),DFN),U)+1
 S $P(^XTMP("BMCRR3",BMCJOB,BMCBTH,"DATA HITS",$P(^DPT(DFN,0),U),DFN),U,2)=$P(^XTMP("BMCRR3",BMCJOB,BMCBTH,"DATA HITS",$P(^DPT(DFN,0),U),DFN),U,2)+BMCDOLL
 Q
