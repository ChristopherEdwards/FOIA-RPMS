BQIPTIMP ;VNGT/HS/ALA-Patient Immunization Forecast Profile ; 28 Jan 2011  8:40 AM
 ;;2.1;ICARE MANAGEMENT SYSTEM;;Feb 07, 2011
 ;
 ;
EN(DATA,DFN) ;EP -- BQI PATIENT IMMUN PROFILE
 ;
 ;Input
 ;  DFN - Patient internal entry number
 ;
 NEW UID,II,GLOB,HDR,BIDLLID,BIDLLRUN,BIRESULT,BISITE
 S UID=$S($G(ZTSK):"Z"_ZTSK,1:$J)
 S DATA=$NA(^TMP("BQIPTIMP",UID)),GLOB=$NA(^TMP("BQIIZ",UID))
 K @DATA,@GLOB
 ;
 S II=0
 NEW $ESTACK,$ETRAP S $ETRAP="D ERR^BQIPTIMM D UNWIND^%ZTER" ; SAC 2006 2.2.3.3.2
 S HDR="T01024REPORT"
 S @DATA@(II)=HDR_$C(30)
 D IMMPROF^BIRPC(.GLOB,DFN,"","")
 S N=0,II=II+1
 F  S N=$O(@GLOB@(N)) Q:N=""  D
 . NEW XX
 . S XX=$$CTRL^BQIUL1(@GLOB@(N))
 . S @DATA@(II)=$G(@DATA@(II))_XX_$C(13)_$C(10)
 S @DATA@(II)=@DATA@(II)_$C(30)
 S II=II+1,@DATA@(II)=$C(31)
 K @GLOB
 Q
