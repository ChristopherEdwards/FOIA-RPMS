BQIUTIL ;VNGT/HS/ALA-Utility Program ; 10 Nov 2008  9:53 AM
 ;;2.1;ICARE MANAGEMENT SYSTEM;;Feb 07, 2011
 ;
MREC(PTDFN,FREF,ITEM) ;EP 
 ; Find the most recent value for a specified item
 ; Input
 ;   PTDFN   - Patient IEN
 ;   FREF    - FileMan file number
 ;   ITEM    - Item (.01 external value)
 ;
 NEW RESULT,GREF,ENDT,IEN,TIEN,TEMP,QFL,XREF,IGREF,RITEM,BQPAR
 S RESULT=0
 ;
 S ITEM=$G(ITEM,"")
 I ITEM="" Q RESULT
 D FIELD^DID(FREF,.01,"","POINTER","BQPAR")
 S IGREF=$G(BQPAR("POINTER")),XREF="""B""" I IGREF="" Q RESULT
 S IGREF=U_IGREF_XREF_")"
 S RITEM=$O(@IGREF@(ITEM,"")) I RITEM="" Q RESULT
 ;
 S GREF=$$ROOT^DILFD(FREF,"",1)
 S TEMP=$NA(^TMP("BQITEMP",UID)) K @TEMP
 S IEN="",QFL=0
 F  S IEN=$O(@GREF@("AC",PTDFN,IEN),-1) Q:'IEN  D
 . S TIEN=$$GET1^DIQ(FREF,IEN,.01,"I") I TIEN="" Q
 . I TIEN'=RITEM Q
 . S VISIT=$$GET1^DIQ(FREF,IEN,.03,"I") I VISIT="" Q
 . I $$GET1^DIQ(9000010,VISIT,.11,"I")=1 Q
 . S VSDTM=$$GET1^DIQ(9000010,VISIT,.01,"I")\1 Q:VSDTM=0
 . ; Set temporary
 . S @TEMP@(VSDTM,VISIT,IEN)=$$GET1^DIQ(FREF,IEN,.04,"E")
 ;
 S VSDTM="",QFL=0
 F  S VSDTM=$O(@TEMP@(VSDTM),-1) Q:VSDTM=""!(QFL)  D
 . S VISIT=""
 . F  S VISIT=$O(@TEMP@(VSDTM,VISIT),-1) Q:VISIT=""  D  Q:QFL
 .. S IEN=""
 .. F  S IEN=$O(@TEMP@(VSDTM,VISIT,IEN),-1) Q:IEN=""  D  Q:QFL
 ... S $P(RESULT,U,2)=VSDTM,$P(RESULT,U,4)=VISIT_U_IEN
 ... S QFL=1,$P(RESULT,U,1)=1,$P(RESULT,U,3)=@TEMP@(VSDTM,VISIT,IEN)
 K @TEMP
 Q RESULT
